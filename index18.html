<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Index17 — Integrated Spectrum Visualizer</title>
  <style>
    :root{--bg:#0f1720;--card:#0b1220;--muted:#9aa4b2;--accent:#9b62ff}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071022,#0b1220);font-family:Inter, Arial, sans-serif;color:#e6eef6}
    .app{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px}
    /* grid and tiles — keep these to match your site layout */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }
    .tile{background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;border-left:6px solid var(--accent)}
    .heading{display:flex;align-items:center;gap:8px;font-weight:600}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    /* visualizer-specific tweaks (keeps look consistent) */
    .fft-canvas{width:100%;height:140px;background:linear-gradient(0deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:6px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .controls input[type=range]{width:160px}
    .btn{background:var(--accent);color:#071022;padding:8px 12px;border-radius:6px;border:0;cursor:pointer}
    footer{margin-top:18px;color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
        <rect x="2" y="3" width="20" height="18" rx="3" fill="#9b62ff" opacity="0.12"></rect>
        <path d="M3 12h18" stroke="#9b62ff" stroke-width="1.5" stroke-linecap="round"></path>
      </svg>
      <div>
        <h1>Index17 — Main Page</h1>
        <div class="muted small">Your app — integrated spectrum visualizer below</div>
      </div>
    </header>

    <!-- ========== MAIN GRID ========== -->
    <div class="grid" id="mainGrid">
      <!-- Example other tiles (you probably have many of these already) -->
      <div class="tile">
        <div class="heading">Existing Card A</div>
        <div class="muted small">This represents an existing card. Your original content goes here.</div>
      </div>

      <div class="tile">
        <div class="heading">Existing Card B</div>
        <div class="muted small">More existing UI — the visualizer will be added below in its own tile to match.</div>
      </div>

      <!-- ========== INTEGRATED SPECTRUM VISUALIZER TILE ==========
           This tile is placed inline in the .grid so its size/spacing matches other cards.
           Do NOT add another copy of this tile elsewhere. The visualizer waits for live data.
      -->
      <div class="tile" id="spectrumTile">
        <div class="heading">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M2 12c4 0 4-8 8-8s4 8 8 8 4 8 8 8" stroke="#c7b3ff" stroke-width="1.2" fill="none"></path>
          </svg>
          Frequency Spectrum
        </div>

        <canvas id="spectrumCanvas" class="fft-canvas" width="900" height="140" style="margin-top:8px"></canvas>

        <div class="controls" style="margin-top:10px">
          <div style="display:flex;align-items:center;gap:6px">
            <div class="small muted">Steps</div>
            <input id="stepsRange" type="range" min="2" max="500" step="1" value="100" disabled />
            <div id="stepsLabel" class="small muted">100</div>
          </div>

          <div style="display:flex;align-items:center;gap:6px">
            <div class="small muted">Spread</div>
            <input id="sigmaRange" type="range" min="0.5" max="10" step="0.1" value="3" disabled />
            <div id="sigmaLabel" class="small muted">3.0</div>
          </div>

          <button id="pauseBtn" class="btn" style="margin-left:auto" disabled>Pause</button>
        </div>

        <div id="spectrumInfo" class="muted small" style="margin-top:8px">Waiting for LIVE data (BLE). Visualizer will start after min/max/ppm arrive.</div>
      </div>
      <!-- ========== END SPECTRUM TILE ========== -->

      <!-- More existing tiles can follow here -->
      <div class="tile">
        <div class="heading">Existing Card C</div>
        <div class="muted small">Other content...</div>
      </div>

    </div>

    <footer>Notes: Visualizer integrated inline into the .grid. It wraps any existing <code>showLive(obj)</code> and will not change other behavior.</footer>
  </div>

  <script>
  (function(){
    // ---------------- State ----------------
    let bins = 100;           // number of steps between min & max (user adjustable)
    let sigma = 3.0;          // gaussian spread
    let minHz = 20000;        // Hz
    let maxHz = 60000;        // Hz
    let ppm = 1.0;            // pulses per minute
    let firstLive = false;    // visualizer waits until we get first live packet
    let running = true;
    let startTime = performance.now();

    // ---------------- DOM ----------------
    const canvas = document.getElementById('spectrumCanvas');
    const ctx = canvas.getContext('2d');
    const stepsRange = document.getElementById('stepsRange');
    const stepsLabel = document.getElementById('stepsLabel');
    const sigmaRange = document.getElementById('sigmaRange');
    const sigmaLabel = document.getElementById('sigmaLabel');
    const pauseBtn = document.getElementById('pauseBtn');
    const infoBar = document.getElementById('spectrumInfo');

    // ---------------- canvas resize ----------------
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const w = canvas.clientWidth || canvas.width;
      const h = canvas.clientHeight || canvas.height;
      canvas.width = Math.max(300, Math.floor(w * dpr));
      canvas.height = Math.max(80, Math.floor(h * dpr));
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    // ---------------- helpers ----------------
    function trianglePos(progress){
      const t = (progress <= 0.5) ? (progress * 2) : (2 - progress * 2);
      return t * (bins - 1);
    }
    function gaussian(x, mu, s){
      const v = (x - mu) / s;
      return Math.exp(-0.5 * v * v);
    }
    function normalizeFreqs(a,b){
      let mn = Number(a);
      let mx = Number(b);
      if(isNaN(mn) || isNaN(mx)) return null;
      if(mn < 1000 && mx < 1000){ mn *= 1000; mx *= 1000; } // assume kHz if <1000
      return {mn, mx};
    }

    // ---------------- drawing ----------------
    function draw(now){
      // if firstLive is false -> show idle text
      if(!firstLive){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "rgba(255,255,255,0.03)";
        ctx.fillRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = "rgba(255,255,255,0.6)";
        ctx.font = "12px Inter, Arial, sans-serif";
        ctx.textBaseline = "middle";
        ctx.fillText("Waiting for LIVE min/max/ppm...", 10, canvas.clientHeight/2);
        requestAnimationFrame(draw);
        return;
      }

      const W = canvas.clientWidth;
      const H = canvas.clientHeight;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const effectivePpm = Math.max(0.0001, ppm);
      const cycleMs = 60000 / effectivePpm;
      const elapsed = now - startTime;
      const progress = (elapsed % cycleMs) / cycleMs;
      const pos = trianglePos(progress);
      const centerFreqHz = minHz + (maxHz - minHz) * (pos / Math.max(1, (bins - 1)));

      // amplitudes
      const amps = new Float32Array(bins);
      let maxAmp = 0;
      for(let i=0;i<bins;i++){
        const a = gaussian(i, pos, sigma);
        amps[i] = a;
        if(a > maxAmp) maxAmp = a;
      }
      if(maxAmp > 0) for(let i=0;i<bins;i++) amps[i] /= maxAmp;

      // draw bars
      const gap = 2;
      const barW = Math.max(2, (W - (bins - 1) * gap) / bins);
      for(let i=0;i<bins;i++){
        const x = i * (barW + gap);
        const amp = amps[i];
        const barH = amp * (H - 10);
        const y = H - barH;
        const dist = Math.abs(i - pos) / bins;
        const alpha = Math.max(0.18, 0.95 * amp);
        const r = Math.round(255 * (0.9 * amp + 0.1));
        const g = Math.round(170 * (0.3 + 0.7*(1 - dist)));
        const b = Math.round(255 * (0.2 + 0.8*(1 - dist)));
        ctx.fillStyle = `rgba(${r},${g},${b},${alpha})`;
        if(Math.abs(i - pos) < 0.5){
          ctx.fillStyle = `rgba(255,210,120,${Math.max(0.5, alpha)})`;
        }

        // rounded bar
        const radius = Math.min(6, barW/2);
        ctx.beginPath();
        ctx.moveTo(x + radius, y);
        ctx.lineTo(x + barW - radius, y);
        ctx.quadraticCurveTo(x + barW, y, x + barW, y + radius);
        ctx.lineTo(x + barW, H);
        ctx.lineTo(x, H);
        ctx.lineTo(x, y + radius);
        ctx.quadraticCurveTo(x, y, x + radius, y);
        ctx.closePath();
        ctx.fill();
      }

      // overlay info
      ctx.fillStyle = "rgba(255,255,255,0.9)";
      ctx.font = "12px Inter, Arial, sans-serif";
      ctx.textBaseline = "top";
      const mink = (minHz/1000).toFixed(3);
      const maxk = (maxHz/1000).toFixed(3);
      infoBar.textContent = `Min: ${mink} kHz · Max: ${maxk} kHz · Speed: ${ppm.toFixed(2)} ppm`;
      ctx.fillText(`${(centerFreqHz/1000).toFixed(3)} kHz`, 6, 6);

      requestAnimationFrame(draw);
    }
    requestAnimationFrame(draw);

    // ---------------- UI wiring ----------------
    stepsRange.addEventListener('input', ()=>{
      bins = Math.max(2, Number(stepsRange.value) || 100);
      stepsLabel.textContent = String(bins);
      startTime = performance.now();
      resize();
    });
    sigmaRange.addEventListener('input', ()=>{
      sigma = Math.max(0.5, Number(sigmaRange.value) || 3.0);
      sigmaLabel.textContent = sigma.toFixed(2);
    });
    pauseBtn.addEventListener('click', ()=>{
      running = !running;
      pauseBtn.textContent = running ? 'Pause' : 'Resume';
      if(running) startTime = performance.now();
    });

    // initially controls are disabled until live packet arrives
    stepsRange.disabled = true;
    sigmaRange.disabled = true;
    pauseBtn.disabled = true;

    // ---------------- showLive wrapper (non-intrusive) ----------------
    const originalShowLive = window.showLive && typeof window.showLive === 'function' ? window.showLive : null;

    window.showLive = function(obj){
      try{
        // call original so nothing changes for the rest of the page
        if(originalShowLive){
          try{ originalShowLive(obj); } catch(e){ console.warn('original showLive error', e); }
        }
        if(!obj) return;

        // pick common names for min/max and waveVal/ppm
        const maybeMin = obj.min_Hz ?? obj.minHz ?? obj.min ?? obj.min_freq ?? null;
        const maybeMax = obj.max_Hz ?? obj.maxHz ?? obj.max ?? obj.max_freq ?? null;
        const maybeWave = obj.waveVal ?? obj.wave_val ?? obj.wave ?? obj.ppm ?? obj.speed ?? null;

        const normalized = normalizeFreqs(maybeMin, maybeMax);
        if(normalized){
          minHz = normalized.mn;
          maxHz = normalized.mx;
        }
        if(maybeWave != null && !isNaN(Number(maybeWave))){
          ppm = Number(maybeWave) || ppm;
        }

        // on first valid live packet enable visualizer UI
        if(!firstLive && normalized){
          firstLive = true;
          running = true;
          startTime = performance.now();
          stepsRange.disabled = false;
          sigmaRange.disabled = false;
          pauseBtn.disabled = false;
          stepsRange.value = bins;
          sigmaRange.value = sigma;
          stepsLabel.textContent = String(bins);
          sigmaLabel.textContent = sigma.toFixed(2);
          infoBar.textContent = `Min: ${(minHz/1000).toFixed(3)} kHz · Max: ${(maxHz/1000).toFixed(3)} kHz · Speed: ${ppm.toFixed(2)} ppm`;
          // small resize to ensure crisp canvas
          setTimeout(resize, 50);
        } else {
          // subsequent updates: reset timing to keep visual sync
          startTime = performance.now();
        }
      }catch(e){ console.warn('spectrum wrapper error', e); }
    };

    // also expose direct setter if other code prefers calling it
    window.__spectrum = {
      setRangeAndPpm: function(min_v, max_v, ppm_v){
        const n = normalizeFreqs(min_v, max_v);
        if(n){ minHz = n.mn; maxHz = n.mx; }
        if(ppm_v != null && !isNaN(Number(ppm_v))) ppm = Number(ppm_v);
        if(!firstLive){
          firstLive = true;
          stepsRange.disabled = false;
          sigmaRange.disabled = false;
          pauseBtn.disabled = false;
        }
        startTime = performance.now();
      },
      setSteps: function(s){ bins = Math.max(2, Number(s)||bins); stepsRange.value = bins; stepsLabel.textContent = String(bins); },
      setSigma: function(s){ sigma = Math.max(0.5, Number(s)||sigma); sigmaRange.value = sigma; sigmaLabel.textContent = sigma.toFixed(2); }
    };

    // pick up any globals if present (non-intrusive)
    try{
      if(typeof window.min_Hz !== 'undefined' && typeof window.max_Hz !== 'undefined'){
        const n = normalizeFreqs(window.min_Hz, window.max_Hz);
        if(n){ minHz = n.mn; maxHz = n.mx; }
      }
      if(typeof window.waveVal !== 'undefined') ppm = Number(window.waveVal) || ppm;
    }catch(e){ /* ignore */ }

    setTimeout(resize, 120);
  })();
  </script>
</body>
</html>
