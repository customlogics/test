<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CARCAT 5G — Dashboard (BLE)</title>
<style>
  :root{
    --bg: #0f1114;
    --card: #14202a;
    --text: #ffffff;
    --muted: #9fb0c0;
    --accent-1: #27b56b;
    --accent-2: #3b82f6;
    --accent-3: #ff9f6b;
    --accent-4: #9b62ff;
    --icon-yellow: #FFD54A;    /* only icons + top title use this */
    --glass: rgba(255,255,255,0.03);
    --card-radius: 14px;
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#0b0c0e 0%, #0f1114 100%); color:var(--text);}
  .wrap{max-width:1120px;margin:18px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:18px;}
  .left{display:flex;flex-direction:column;gap:18px;}
  .hero{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:18px;border-left:6px solid var(--accent-1);}
  .hero h1{margin:0;font-size:20px;color:var(--icon-yellow)} /* only the top title is yellow */
  .hero p{margin:8px 0 0 0;color:var(--muted);font-size:13px;}
  .small-card{background:var(--card); padding:12px; border-radius:12px; border-left:6px solid var(--accent-2); color:inherit}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;}
  .tile{background:var(--card); border-radius:var(--card-radius); padding:18px; position:relative; overflow:hidden; box-shadow:0 6px 20px rgba(3,6,9,0.6);}
  .tile .heading{font-size:16px;font-weight:800;margin-bottom:8px;color:var(--text);display:flex;align-items:center;gap:10px}
  .tile .sub{color:var(--muted);font-size:13px;margin-top:8px}
  .metric{display:flex;align-items:center;gap:12px}
  .metric .value{font-size:26px;font-weight:800;color:var(--text)}
  .metric .unit{color:var(--muted);font-size:12px}
  .feature-card { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .feature-left {flex:1}
  .feature-title { font-weight:800; color:var(--text) }
  .feature-sub { color:var(--muted); font-size:12px; margin-top:6px }
  .feature-value { font-size:20px; font-weight:800; margin-top:6px; color:var(--text) }
  .gear { border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); padding:8px; cursor:pointer; color:var(--muted); font-weight:700 }
  .small-muted { color:var(--muted); font-size:12px }
  .raw { background:var(--glass); padding:10px; border-radius:10px; font-family:monospace; color:var(--accent-1); font-size:13px; height:120px; overflow:auto; border:1px solid rgba(255,255,255,0.03) }
  .footer{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-top:6px;padding:12px 18px;background:transparent}
  .connectBtn{padding:8px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),#9be7ff);color:#072031;border:none;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer}
  .badge { display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02); font-weight:700; color:var(--muted); font-size:13px }

  /* ICONS: doubled to 32px (was 16px), stroke slightly increased */
  .icon { width:32px; height:32px; display:inline-block; vertical-align:middle; }
  svg.icon path, svg.icon rect, svg.icon circle { stroke: var(--icon-yellow); stroke-width:1.6; fill: none; }
  svg.icon rect.filled { fill: var(--icon-yellow); stroke: none; }

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{width:420px;background:#f2f8ff;color:#0b1220;border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,0.25);position:relative}
  .modal h2{margin:0 0 8px 0;text-align:center}
  .toggle{display:flex;justify-content:center;align-items:center;gap:12px;margin:8px 0 14px 0}
  .switch{width:54px;height:30px;background:#ddd;border-radius:18px;position:relative}
  .switch.on{background:#111}
  .knob{width:24px;height:24px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:left .12s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
  .switch.on .knob{left:27px}
  .modal input[type="range"]{width:100%}
  .muted{color:var(--muted)}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:12px}.grid{grid-template-columns:1fr}}

  .radio-group { display: flex; gap: 8px; margin-bottom: 8px; }
  .radio-group input[type="radio"] { accent-color: var(--accent-2); }
  .radio-group label { color: var(--muted); font-size: 12px; cursor: pointer; user-select: none; }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="left">
      <div class="hero">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h1>CARCAT 5G - Wave</h1>
            <p>Car Battery Monitor & Config — BLE control & live telemetry</p>
          </div>
          <div style="text-align:right">
            <div class="muted">Connected to:</div>
            <div id="deviceName" class="badge">Not connected</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="connectButton" type="button" class="connectBtn">Connect</button>
          <button id="disconnectButton" class="btn-ghost" disabled>Disconnect</button>
          <button id="sendLiveBtn" class="btn-ghost" disabled>SEND LIVE</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="sendInitBtn" class="btn-ghost" disabled>SEND INIT</button>
          <button id="startAutoBtn" class="btn-ghost" disabled>Start Auto (500ms)</button>
          <button id="stopAutoBtn" class="btn-ghost" disabled>Stop Auto</button>
        </div>

        <div style="margin-top:12px" class="muted">Raw receive (Docklight hex)</div>
        <div id="recvRaw" class="raw"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="clearRaw" class="btn-ghost">Clear</button>
          <button id="forceParse" class="btn-ghost">Force LIVE Parse</button>
        </div>
      </div>

      <div class="small-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700; color:var(--text)">Quick</div>
            <div class="muted" style="margin-top:6px">Console logs for TX/RX are in browser console</div>
          </div>
          <div>
            <button id="openSetup" class="btn-ghost">Setup</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:18px;font-weight:800; color:var(--text)">Dashboard</div>
        <div class="muted">Auto: <span id="autoStatus">Idle</span></div>
      </div>

      <div class="grid">
        <div class="tile" id="card_voltage" style="border-left:6px solid var(--accent-1)">
          <div class="heading">
            <!-- battery icon -->
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <rect x="2" y="6" width="16" height="12" rx="2"></rect>
              <rect class="filled" x="19" y="9" width="2" height="6" rx="0.5"></rect>
            </svg>
            Car Battery Voltage
          </div>
          <div class="metric">
            <div class="value" id="card_battery">-- V</div>
            <div class="unit muted" id="liveExtra">instant</div>
          </div>
          <div class="sub" id="card_battery_sub">From LIVE packet</div>
        </div>

        <!-- CURRENT card -->
        <div class="tile" id="card_current" style="border-left:6px solid #ffcc00">
          <div class="heading">
            <!-- current icon -->
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 12h7l2 6 2-12 2 6h4"></path>
            </svg>
            Device Current
          </div>
          <div class="metric">
            <div class="value" id="card_current_val">-- mA</div>
            <div class="unit muted">instant</div>
          </div>
          <div class="sub">From LIVE packet (bytes 12-13)</div>
        </div>

        <!-- NEW DEVICE MODE CARD - inserted here at start of dashboard tiles, after current -->
        <div class="tile" id="card_device_mode" style="border-left:6px solid var(--accent-4)">
          <div class="heading">
            <!-- power/mode icon -->
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
            </svg>
            Device Status
          </div>
          <div class="feature-value" id="card_mode_val">-- mode</div>
          <div class="sub">From LIVE packet (byte 23)</div>
        </div>

        <div class="tile" id="card_temp" style="border-left:6px solid #d6a93e">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M14 14.76V6a2 2 0 1 0-4 0v8.76a4 4 0 1 0 4 0z"></path>
            </svg>
            Internal Temperature
          </div>
          <div class="feature-value" id="card_temp_value">-- °C</div>
          <div class="sub">CARCAT internal temperature</div>
        </div>

        <div class="tile" id="card_freq_min" style="border-left:6px solid var(--accent-1)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M4 12h2l2-4 2 8 2-4 2 6 2-10 2 6h2"></path>
            </svg>
            Min Frequency (current)
          </div>
          <div class="feature-value" id="card_minfreq">-- kHz</div>
          <div class="sub">From LIVE packet</div>
        </div>
        <div class="tile" id="card_freq_max" style="border-left:6px solid var(--accent-3)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 12h3l2-6 2 12 2-8 2 10 2-14 2 8h2"></path>
            </svg>
            Max Frequency (current)
          </div>
          <div class="feature-value" id="card_maxfreq">-- kHz</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <div class="tile" id="card_wave" style="border-left:6px solid var(--accent-4)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M2 12c4 0 4-8 8-8s4 8 8 8 4 8 8 8"></path>
            </svg>
            Wave velocity (current)
          </div>
          <div class="feature-value" id="card_waveval">--</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <div class="tile" id="card_spectrum" style="border-left:6px solid #8b5cf6">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 18h2v-6H3zm4 0h2v-4H7zm4 0h2v-8h-2zm4 0h2v-5h-2zm4 0h2v-3h-2zM3 12h2V8H3zm4 0h2V6H7zm4 0h2V4h-2zm4 0h2V9h-2zm4 0h2V7h-2z"></path>
            </svg>
            Spectrum analysis
          </div>
          <div class="radio-group">
            <input type="radio" id="modeFft" name="spectrumMode">
            <label for="modeFft">FFT</label>
            <input type="radio" id="modeWaterfall" name="spectrumMode" checked>
            <label for="modeWaterfall">Waterfall</label>
          </div>
          <canvas id="spectrumCanvas" style="width:100%; height:160px; border-radius:8px; background:var(--card); display:block; margin-top:8px;"></canvas>
          <div style="margin-top:8px; display:flex; justify-content:space-between; gap:4px; font-size:12px;">
            <div><span class="small-muted">Min Freq:</span> <span id="spec_minfreq" style="color:var(--text); font-weight:600;">-- kHz</span></div>
            <div><span class="small-muted">Max Freq:</span> <span id="spec_maxfreq" style="color:var(--text); font-weight:600;">-- kHz</span></div>
            <div><span class="small-muted">Velocity:</span> <span id="spec_wave" style="color:var(--text); font-weight:600;">-- ppm</span></div>
            <div><span class="small-muted">Pattern:</span> <span id="spec_pattern" style="color:var(--text); font-weight:600;">--</span></div>
          </div>
        </div>

        <div class="tile" id="card_pattern" style="border-left:6px solid var(--accent-2)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M6 8c2 0 2-4 4-4s2 4 4 4 2-4 4-4"></path>
            </svg>
            Ultrasound pattern
          </div>
          <div class="feature-value" id="card_pattern_val">--</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <div class="tile" id="card_uptime" style="border-left:6px solid #5b2133">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M12 6v6l4 2"></path>
              <circle cx="12" cy="12" r="9"></circle>
            </svg>
            Device UP-Time
          </div>
          <div class="feature-value" id="card_days">-- Days</div>
          <div class="sub" id="card_hhmmss">--:--:-- (HH:MM:SS)</div>
        </div>

        <!-- INIT feature cards -->
        <div class="tile" id="feat_beep_card" style="border-left:6px solid #ff6fa6">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M5 11h4l5-5v12l-5-5H5z"></path>
                </svg>
                Audible beep
              </div>
              <div class="feature-sub">Duration — after every</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="beep_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="beep" title="Edit audible beep">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="beep_set">-- s</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="beep_default_card">-- s</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="beep_minmax">-- / -- s</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_standby_card" style="border-left:6px solid #39d0ff">
          <div class="feature-title">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
            </svg>
            Standby mode
          </div>
          <div class="feature-sub">Charging voltage threshold</div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="standby_set">-- V</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="standby_default_card">-- V</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="standby_minmax">-- / -- V</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="standby_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="standby" title="Edit standby mode">⚙</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_shutdown_card" style="border-left:6px solid #ff4081">
          <div class="feature-title">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"></path>
            </svg>
            Shutdown mode
          </div>
          <div class="feature-sub">Cut-off voltage</div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="shutdown_set">-- V</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="shutdown_default_card">-- V</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="shutdown_minmax">-- / -- V</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="shutdown_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="shutdown" title="Edit shutdown mode">⚙</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_hiss_card" style="border-left:6px solid #00bcd4">
          <div class="feature-title">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path>
            </svg>
            Audible Hiss band
          </div>
          <div class="feature-sub">Play frequency (band %)</div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="hiss_set">-- %</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="hiss_default_card">-- %</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="hiss_minmax">-- / -- %</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="hiss_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="hiss" title="Edit audible hiss">⚙</div>
            </div>
          </div>
        </div>

        <div class="tile" id="rawLogCard" style="border-left:6px solid var(--accent-3); grid-column: 1 / -1;">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
            </svg>
            Raw Packet Log
          </div>
          <div id="rawLog" class="raw" style="height: 140px; font-size: 11px;"></div>
          <div style="margin-top: 8px; display: flex; gap: 8px; justify-content: flex-end;">
            <button id="clearLog" class="btn-ghost" style="font-size: 12px;">Clear Log</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for feature editing -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h2 id="modalTitle">Edit Feature</h2>
      <div class="toggle" id="modalToggle">
        <span class="muted" style="font-size:12px;">Disabled</span>
        <div class="switch">
          <div class="knob"></div>
        </div>
        <span style="font-weight:700;">Enabled</span>
      </div>
      <div style="margin:12px 0;">
        <label id="sliderLabel" class="muted" style="display:block; margin-bottom:4px;">Slider</label>
        <div style="display:flex; gap:12px; align-items:center; font-size:12px;">
          <span id="sliderMinLabel">--</span>
          <input id="modalSlider" type="range" min="0" max="100" value="0" style="flex:1;">
          <span id="sliderMaxLabel">--</span>
        </div>
        <div style="text-align:center; margin-top:8px; font-weight:700; color:var(--text);" id="modalSliderValue">0</div>
      </div>
      <div style="display:flex; gap:8px; justify-content:center;">
        <button id="modalReset" class="btn-ghost">Reset to Default</button>
        <button id="modalSave" class="connectBtn" style="padding:8px 16px;">Save</button>
        <button id="modalClose" class="btn-ghost">Cancel</button>
      </div>
    </div>
  </div>

  <script>
/* BLE UUIDs - UNCHANGED */
const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const WRITE_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const NOTIFY_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

/* Global state - UNCHANGED except for new mode in showLive */
let device = null;
let writeChar = null;
let notifyChar = null;
let autoIntervalId = null;
let currentInitData = null;
let editingFeature = null;
let awaitingInitPromise = null;
let pendingSave = null;
let writeInProgress = false;
let lastPacket = null;

/* DOM elements - ADD new for device mode */
const deviceName = document.getElementById('deviceName');
const connectButton = document.getElementById('connectButton');
const disconnectButton = document.getElementById('disconnectButton');
const sendLiveBtn = document.getElementById('sendLiveBtn');
const sendInitBtn = document.getElementById('sendInitBtn');
const startAutoBtn = document.getElementById('startAutoBtn');
const stopAutoBtn = document.getElementById('stopAutoBtn');
const autoStatus = document.getElementById('autoStatus');
const recvRaw = document.getElementById('recvRaw');
const clearRaw = document.getElementById('clearRaw');
const forceParse = document.getElementById('forceParse');
const card_battery = document.getElementById('card_battery');
const card_current_val = document.getElementById('card_current_val');
const card_temp_value = document.getElementById('card_temp_value');
const card_minfreq = document.getElementById('card_minfreq');
const card_maxfreq = document.getElementById('card_maxfreq');
const card_waveval = document.getElementById('card_waveval');
const card_pattern_val = document.getElementById('card_pattern_val');
const card_days = document.getElementById('card_days');
const card_hhmmss = document.getElementById('card_hhmmss');
const card_mode_val = document.getElementById('card_mode_val'); // NEW
const spec_minfreq = document.getElementById('spec_minfreq');
const spec_maxfreq = document.getElementById('spec_maxfreq');
const spec_wave = document.getElementById('spec_wave');
const spec_pattern = document.getElementById('spec_pattern');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalTitle = document.getElementById('modalTitle');
const modalToggle = document.getElementById('modalToggle');
const modalSlider = document.getElementById('modalSlider');
const sliderLabel = document.getElementById('sliderLabel');
const sliderMinLabel = document.getElementById('sliderMinLabel');
const sliderMaxLabel = document.getElementById('sliderMaxLabel');
const modalSliderValue = document.getElementById('modalSliderValue');
const modalReset = document.getElementById('modalReset');
const modalSave = document.getElementById('modalSave');
const modalClose = document.getElementById('modalClose');

/* Spectrum globals - UNCHANGED */
let currentMode = 'waterfall';
let isAnimating = false;
let animationStartTime = 0;
let waterfallLines = [];
let currentWavePpm = 0;
const canvas = document.getElementById('spectrumCanvas');
const ctx = canvas.getContext('2d');

/* Helper functions - UNCHANGED except parseLivePacket and showLive */
function bytesToHexUpper(arr) { return Array.from(arr, b => b.toString(16).padStart(2, '0').toUpperCase()).join(' '); }
function appendRaw(arr, tag) {
  const ts = new Date().toISOString().slice(11, 23);
  const line = `[${ts}] ${tag ? tag + ': ' : ''}${bytesToHexUpper(arr)}\n`;
  recvRaw.textContent += line;
  recvRaw.scrollTop = recvRaw.scrollHeight;
  lastPacket = arr;
}
function isTagAt(buf, offset, tag) {
  const tagBuf = new TextEncoder().encode(tag);
  for (let i = 0; i < tagBuf.length; i++) {
    if (buf[offset + i] !== tagBuf[i]) return false;
  }
  return true;
}
function writeFrame(frame, desc) {
  if (!writeChar) throw new Error("No write characteristic");
  writeInProgress = true;
  return writeChar.writeValue(frame).finally(() => { writeInProgress = false; })
    .then(() => console.log(`TX ${desc}: ${bytesToHexUpper(frame)}`));
}

/* UPDATED: parseLivePacket - add deviceStatus extraction at buf[23], shift uptime offsets, update length check to 33 */
function parseLivePacket(buf) {
  if (buf.length !== 33) return { error: `Invalid length: expected 33, got ${buf.length}` };
  const len = (buf[5] << 8) | buf[4];
  if (len !== 23) return { error: `Invalid data len: expected 23, got ${len}` };
  if (!isTagAt(buf, 0, "FDFCFBFA")) return { error: "Invalid frame start" };
  if (!isTagAt(buf, 28, "04030201")) return { error: "Invalid frame end" };
  if (!isTagAt(buf, 6, "LIVE")) return { error: "Not LIVE packet" };

  // Extract values (little-endian)
  const battery_mv = (buf[11] << 8) | buf[10];
  const current_ua = (buf[13] << 8) | buf[12];
  const temp_c100 = (buf[15] << 8) | buf[14];
  const min_hz1000 = (buf[17] << 8) | buf[16];
  const max_hz1000 = (buf[19] << 8) | buf[18];
  const wave_ppm = (buf[21] << 8) | buf[20];
  const pattern = buf[22];
  const deviceStatus = buf[23]; // NEW: enum byte
  const days = (buf[25] << 8) | buf[24]; // shifted +1
  const hh = buf[26]; // shifted
  const mm = buf[27]; // shifted
  const ss = buf[28]; // shifted

  // Map pattern (assuming existing map, e.g.)
  const patternMap = { 0: 'Off', 1: 'Straight', 2: 'Sweep', 3: 'Zig-Zag' }; // adjust as per actual
  const patternStr = patternMap[pattern] || 'Unknown';

  // NEW: Map device status enum
  const statusMap = ['Idle mode', 'Run mode', 'Shutdown mode', 'Standby mode'];
  const modeStr = statusMap[deviceStatus] || `Unknown (${deviceStatus})`;

  return {
    battery_v: (battery_mv / 1000).toFixed(2),
    current_ma: (current_ua / 1000).toFixed(2),
    temp_c: (temp_c100 / 100).toFixed(0),
    min_khz: (min_hz1000 / 1000).toFixed(1),
    max_khz: (max_hz1000 / 1000).toFixed(1),
    wave_ppm,
    pattern: patternStr,
    mode: modeStr, // NEW
    uptime: `${days} Days ${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')} (HH:MM:SS)`,
    _rawBuf: buf
  };
}

/* UPDATED: showLive - add update for card_mode_val */
function showLive(parsed) {
  card_battery.textContent = parsed.battery_v;
  card_current_val.textContent = parsed.current_ma;
  card_temp_value.textContent = parsed.temp_c;
  card_minfreq.textContent = parsed.min_khz;
  card_maxfreq.textContent = parsed.max_khz;
  card_waveval.textContent = parsed.wave_ppm;
  card_pattern_val.textContent = parsed.pattern;
  card_days.textContent = parsed.uptime.split(' ')[0] + ' Days';
  card_hhmmss.textContent = parsed.uptime.split(' ').slice(1).join(' ');

  // NEW: Update device mode card
  card_mode_val.textContent = parsed.mode;

  // Update spectrum labels
  spec_minfreq.textContent = parsed.min_khz + ' kHz';
  spec_maxfreq.textContent = parsed.max_khz + ' kHz';
  spec_wave.textContent = parsed.wave_ppm + ' ppm';
  spec_pattern.textContent = parsed.pattern;

  currentWavePpm = parsed.wave_ppm;

  if (currentMode === 'waterfall' || currentMode === 'fft') {
    if (!isAnimating && currentWavePpm > 0) {
      isAnimating = true;
      animationStartTime = performance.now();
      requestAnimationFrame(animateSpectrum);
    }
  }

  liveExtra.textContent = 'live';
  card_battery_sub.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
}

/* UNCHANGED: parseInitPacket, showInit, etc. - assuming they exist as per previous code */

/* UNCHANGED: connect, onDeviceConnected, onDeviceDisconnected, disconnect, onNotify (update length check to >=29) */
async function connect() {
  try {
    device = await navigator.bluetooth.requestDevice({
      filters: [{ services: [SERVICE_UUID] }],
      optionalServices: [SERVICE_UUID]
    });
    device.addEventListener('gattserverdisconnected', onDeviceDisconnected);
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    writeChar = await service.getCharacteristic(WRITE_UUID);
    notifyChar = await service.getCharacteristic(NOTIFY_UUID);
    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', onNotify);

    deviceName.textContent = device.name || device.id.slice(-4);
    bleText.textContent = "Connected";
    statusDot.style.background = "#27b56b";

    connectButton.disabled = true;
    disconnectButton.disabled = false;
    sendLiveBtn.disabled = false;
    sendInitBtn.disabled = false;
    startAutoBtn.disabled = false;
    stopAutoBtn.disabled = true;
  } catch (e) {
    console.error("Connect error:", e);
    alert("Connection failed: " + e.message);
  }
}

function onDeviceDisconnected(event) {
  const dev = event?.target;
  console.log("Device disconnected:", dev ? (dev.name || dev.id) : dev);
  stopAutoLive();
  isAnimating = false;
  deviceName.textContent = "Not connected";
  bleText.textContent = "Disconnected";
  statusDot.style.background = "#ff6b6b";

  connectButton.disabled = false;
  disconnectButton.disabled = true;
  sendLiveBtn.disabled = true;
  sendInitBtn.disabled = true;
  startAutoBtn.disabled = true;
  stopAutoBtn.disabled = true;
}

async function disconnect() {
  stopAutoLive();
  isAnimating = false;
  try {
    if (device) {
      console.log("Disconnect requested for device:", device.name || device.id);
      if (device.gatt && device.gatt.connected) {
        device.gatt.disconnect();
        console.log("Device gatt.disconnect() called");
      } else {
        console.log("Device was already disconnected.");
      }
    }
  } catch (e) {
    console.error("Error during disconnect:", e);
  } finally {
    deviceName.textContent = "Not connected";
    bleText.textContent = "Disconnected";
    statusDot.style.background = "#ff6b6b";

    connectButton.disabled = false;
    disconnectButton.disabled = true;
    sendLiveBtn.disabled = true;
    sendInitBtn.disabled = true;
    startAutoBtn.disabled = true;
    stopAutoBtn.disabled = true;
  }
}

/* UPDATED: onNotify - change length check to >=29 for new 33-byte LIVE */
function onNotify(ev){
  const arr = new Uint8Array(ev.target.value.buffer);

  if (isTagAt(arr, 6, "LIVE") && arr.length >= 29) { // UPDATED: >=29
    appendRaw(arr, 'LIVE');
    const liveParsed = parseLivePacket(arr);
    if (!liveParsed.error) showLive(liveParsed);
    return;
  }

  if (isTagAt(arr, 6, "INIT") && arr.length >= 51) {
    appendRaw(arr, 'INIT');
    const initParsed = parseInitPacket(arr);
    if (!initParsed.error) {
      showInit(initParsed);

      // resolve any waiting gear -> INIT request
      try {
        if (awaitingInitPromise && typeof awaitingInitPromise._resolve === 'function') {
          awaitingInitPromise._resolve(initParsed);
          awaitingInitPromise = null;
        }
      } catch (e) { console.warn("Error resolving awaitingInitPromise", e); }

      // check pending save ack (byte index 10 == 1)
      try {
        const buf = initParsed._rawBuf;
        if (pendingSave && buf && buf.length > 10 && buf[10] === 1) {
          console.log("ACK INIT received (byte10==1) for pending save");
          pendingSave.resolve({ feature: pendingSave.feature, value: pendingSave.value, buf });
          pendingSave = null;
        }
      } catch (e) { console.warn("ack check error", e); }
    }
    return;
  }

  appendRaw(arr, '');
}

/* UNCHANGED: Auto LIVE, waitForNextInit, waitForInitAck, performSaveWrite, modal helpers, openFeatureModal, event listeners, etc. */
function startAutoLive(){
  if(autoIntervalId) return;
  if(!writeChar){ alert("Not connected"); return; }
  autoStatus.textContent = "Auto ON";
  startAutoBtn.disabled = true;
  stopAutoBtn.disabled = false;
  autoIntervalId = setInterval(()=>{ if(!writeInProgress) sendLiveCmd(); },500);
}
function stopAutoLive(){
  if(autoIntervalId) clearInterval(autoIntervalId);
  autoIntervalId = null;
  autoStatus.textContent = "Idle";
  startAutoBtn.disabled = false;
  stopAutoBtn.disabled = true;
}

async function sendLiveCmd() {
  if (!writeChar) return;
  const frame = new Uint8Array([
    0xFD, 0xFC, 0xFB, 0xFA,  // start
    0x04, 0x00,              // len=4
    0x4C, 0x49, 0x56, 0x45,  // LIVE
    0x04, 0x03, 0x02, 0x01   // end
  ]);
  await writeFrame(frame, 'LIVE');
}

async function sendInitCmd() {
  if (!writeChar) return;
  const frame = new Uint8Array([
    0xFD, 0xFC, 0xFB, 0xFA,  // start
    0x04, 0x00,              // len=4
    0x49, 0x4E, 0x49, 0x54,  // INIT
    0x04, 0x03, 0x02, 0x01   // end
  ]);
  await writeFrame(frame, 'INIT');
}

// ... (rest of modal, gear, UI wiring, spectrum animation unchanged - omitted for brevity as per truncation in input)

if(!navigator.bluetooth){
  alert("Web Bluetooth not available in this browser.");
  connectButton.disabled = true;
  startAutoBtn.disabled = true;
  sendInitBtn.disabled = true;
  stopAutoBtn.disabled = true;
}

window.addEventListener('resize', () => {
  if (isAnimating) {
    animationStartTime = performance.now();
    requestAnimationFrame(animateSpectrum);
  }
});
  </script>
</body>
</html>
