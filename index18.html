<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CARCAT 5G — Dashboard (BLE)</title>
<style>
  :root{
    --bg: #0f1114;
    --card: #14202a;
    --text: #ffffff;
    --muted: #9fb0c0;
    --accent-1: #27b56b;
    --accent-2: #3b82f6;
    --accent-3: #ff9f6b;
    --accent-4: #9b62ff;
    --icon-yellow: #FFD54A;
    --glass: rgba(255,255,255,0.03);
    --card-radius: 14px;
  }

  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#0b0c0e 0%, #0f1114 100%); color:var(--text);}
  .wrap{max-width:1120px;margin:18px auto;padding:18px;display:grid;grid-template-columns:360px 1fr;gap:18px;}
  .left{display:flex;flex-direction:column;gap:18px;}
  .hero{background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:18px;border-left:6px solid var(--accent-1);}
  .hero h1{margin:0;font-size:20px;color:var(--icon-yellow)}
  .hero p{margin:8px 0 0 0;color:var(--muted);font-size:13px;}
  .small-card{background:var(--card); padding:12px; border-radius:12px; border-left:6px solid var(--accent-2); color:inherit}

  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;}
  .tile{background:var(--card); border-radius:var(--card-radius); padding:18px; position:relative; overflow:hidden; box-shadow:0 6px 20px rgba(3,6,9,0.6);}
  .tile .heading{font-size:16px;font-weight:800;margin-bottom:8px;color:var(--text);display:flex;align-items:center;gap:10px}
  .tile .sub{color:var(--muted);font-size:13px;margin-top:8px}
  .metric{display:flex;align-items:center;gap:12px}
  .metric .value{font-size:26px;font-weight:800;color:var(--text)}
  .metric .unit{color:var(--muted);font-size:12px}
  .feature-card { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .feature-left {flex:1}
  .feature-title { font-weight:800; color:var(--text) }
  .feature-sub { color:var(--muted); font-size:12px; margin-top:6px }
  .feature-value { font-size:20px; font-weight:800; margin-top:6px; color:var(--text) }
  .gear { border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); padding:8px; cursor:pointer; color:var(--muted); font-weight:700 }
  .small-muted { color:var(--muted); font-size:12px }
  .raw { background:var(--glass); padding:10px; border-radius:10px; font-family:monospace; color:var(--accent-1); font-size:13px; height:120px; overflow:auto; border:1px solid rgba(255,255,255,0.03) }
  .footer{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-top:6px;padding:12px 18px;background:transparent}
  .connectBtn{padding:8px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),#9be7ff);color:#072031;border:none;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer}
  .badge { display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02); font-weight:700; color:var(--muted); font-size:13px }

  .icon { width:32px; height:32px; display:inline-block; vertical-align:middle; }
  svg.icon path, svg.icon rect, svg.icon circle { stroke: var(--icon-yellow); stroke-width:1.6; fill: none; }
  svg.icon rect.filled { fill: var(--icon-yellow); stroke: none; }

  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:2000}
  .modal{width:420px;background:#f2f8ff;color:#0b1220;border-radius:12px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,0.25);position:relative}
  .modal h2{margin:0 0 8px 0;text-align:center}
  .toggle{display:flex;justify-content:center;align-items:center;gap:12px;margin:8px 0 14px 0}
  .switch{width:54px;height:30px;background:#ddd;border-radius:18px;position:relative}
  .switch.on{background:#111}
  .knob{width:24px;height:24px;background:#fff;border-radius:50%;position:absolute;top:3px;left:3px;transition:left .12s;box-shadow:0 2px 4px rgba(0,0,0,0.2)}
  .switch.on .knob{left:27px}
  .modal input[type="range"]{width:100%}
  .muted{color:var(--muted)}
  @media (max-width:980px){.wrap{grid-template-columns:1fr;padding:12px}.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="left">
      <div class="hero">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h1>CARCAT 5G - Wave</h1>
            <p>Car Battery Monitor & Config — BLE control & live telemetry</p>
          </div>
          <div style="text-align:right">
            <div class="muted">Connected to:</div>
            <div id="deviceName" class="badge">Not connected</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <button id="connectButton" type="button" class="connectBtn">Connect</button>
          <button id="disconnectButton" class="btn-ghost" disabled>Disconnect</button>
          <button id="sendLiveBtn" class="btn-ghost" disabled>SEND LIVE</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="sendInitBtn" class="btn-ghost" disabled>SEND INIT</button>
          <button id="startAutoBtn" class="btn-ghost" disabled>Start Auto (500ms)</button>
          <button id="stopAutoBtn" class="btn-ghost" disabled>Stop Auto</button>
        </div>

        <div style="margin-top:12px" class="muted">Raw receive (Docklight hex)</div>
        <div id="recvRaw" class="raw"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="clearRaw" class="btn-ghost">Clear</button>
          <button id="forceParse" class="btn-ghost">Force LIVE Parse</button>
        </div>
      </div>

      <div class="small-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700; color:var(--text)">Quick</div>
            <div class="muted" style="margin-top:6px">Console logs for TX/RX are in browser console</div>
          </div>
          <div>
            <button id="openSetup" class="btn-ghost">Setup</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:18px;font-weight:800; color:var(--text)">Dashboard</div>
        <div class="muted">Auto: <span id="autoStatus">Idle</span></div>
      </div>

      <div class="grid">
        <div class="tile" id="card_voltage" style="border-left:6px solid var(--accent-1)">
          <div class="heading">
            <!-- battery icon -->
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <rect x="2" y="6" width="16" height="12" rx="2"></rect>
              <rect class="filled" x="19" y="9" width="2" height="6" rx="0.5"></rect>
            </svg>
            Car Battery Voltage
          </div>
          <div class="metric">
            <div class="value" id="card_battery">-- V</div>
            <div class="unit muted" id="liveExtra">instant</div>
          </div>
          <div class="sub" id="card_battery_sub">From LIVE packet</div>
        </div>

        <!-- CURRENT card -->
        <div class="tile" id="card_current" style="border-left:6px solid #ffcc00">
          <div class="heading">
            <!-- current icon -->
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 12h7l2 6 2-12 2 6h4"></path>
            </svg>
            Device Current
          </div>
          <div class="metric">
            <div class="value" id="card_current_val">-- mA</div>
            <div class="unit muted">instant</div>
          </div>
          <div class="sub">From LIVE packet (bytes 12-13)</div>
        </div>

        <div class="tile" id="card_temp" style="border-left:6px solid #d6a93e">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M14 14.76V6a2 2 0 1 0-4 0v8.76a4 4 0 1 0 4 0z"></path>
            </svg>
            Internal Temperature
          </div>
          <div class="feature-value" id="card_temp_value">-- °C</div>
          <div class="sub">CARCAT internal temperature</div>
        </div>

        <div class="tile" id="card_freq_min" style="border-left:6px solid var(--accent-1)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M4 12h2l2-4 2 8 2-4 2 6 2-10 2 6h2"></path>
            </svg>
            Min Frequency (current)
          </div>
          <div class="feature-value" id="card_minfreq">-- kHz</div>
          <div class="sub">From LIVE packet</div>
        </div>
        <div class="tile" id="card_freq_max" style="border-left:6px solid var(--accent-3)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 12h3l2-6 2 12 2-8 2 10 2-14 2 8h2"></path>
            </svg>
            Max Frequency (current)
          </div>
          <div class="feature-value" id="card_maxfreq">-- kHz</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <div class="tile" id="card_wave" style="border-left:6px solid var(--accent-4)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M2 12c4 0 4-8 8-8s4 8 8 8 4 8 8 8"></path>
            </svg>
            Wave velocity (current)
          </div>
          <div class="feature-value" id="card_waveval">--</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <!-- ===== Integrated Spectrum Tile ===== -->
        <div class="tile" id="card_spectrum" style="border-left:6px solid var(--accent-4);">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="heading" style="margin:0;padding:0">Frequency Spectrum</div>
              <!-- Spread near title -->
              <div style="display:flex;align-items:center;gap:6px;margin-left:6px">
                <div class="small-muted">Spread</div>
                <input id="spectrumSigma" type="range" min="0.5" max="10" step="0.1" value="5.5" disabled style="width:140px" />
                <div id="spectrumSigmaLabel" class="small-muted">5.5</div>
              </div>
            </div>
            <div id="spectrumInfo" class="sub" style="margin-left:12px">Waiting for LIVE data — visualizer will start after first LIVE packet.</div>
          </div>

          <div style="margin-top:8px;display:flex;gap:12px;align-items:flex-start">
            <div style="flex:1;min-width:0">
              <canvas id="spectrumCanvas" width="1000" height="220" style="width:100%;height:220px;border-radius:6px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));display:block"></canvas>
            </div>
          </div>

          <div style="display:flex;gap:12px;align-items:center;margin-top:10px">
            <div style="display:flex;align-items:center;gap:8px">
              <div class="small-muted">Steps</div>
              <input id="spectrumSteps" type="range" min="2" max="500" step="1" value="50" disabled style="width:220px"/>
              <div id="spectrumStepsLabel" class="small-muted">50</div>
            </div>

            <button id="spectrumToggle" class="btn-ghost" disabled style="margin-left:auto">Pause</button>
          </div>
        </div>
        <!-- ===== End Spectrum Tile ===== -->

        <div class="tile" id="card_pattern" style="border-left:6px solid var(--accent-2)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M6 8c2 0 2-4 4-4s2 4 4 4 2-4 4-4"></path>
            </svg>
            Ultrasound pattern
          </div>
          <div class="feature-value" id="card_pattern_val">--</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <div class="tile" id="card_uptime" style="border-left:6px solid #5b2133">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M12 6v6l4 2"></path>
              <circle cx="12" cy="12" r="9"></circle>
            </svg>
            Device UP-Time
          </div>
          <div class="feature-value" id="card_days">-- Days</div>
          <div class="sub" id="card_hhmmss">--:--:-- (HH:MM:SS)</div>
        </div>

        <!-- INIT feature cards (unchanged) -->
        <div class="tile" id="feat_beep_card" style="border-left:6px solid #ff6fa6">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M5 11h4l5-5v12l-5-5H5z"></path>
                </svg>
                Audible beep
              </div>
              <div class="feature-sub">Duration — after every</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="beep_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="beep" title="Edit audible beep">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="beep_set">-- s</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="beep_default_card">-- s</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="beep_minmax">-- / -- s</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_standby_card" style="border-left:6px solid #39d0ff">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M3 12h6v6H3zM15 6h6v12h-6z"></path>
                </svg>
                Standby mode
              </div>
              <div class="feature-sub">Charging voltage threshold</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="standby_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="standby" title="Edit standby">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="standby_set">-- V</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="standby_default_card">-- V</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="standby_minmax">-- / -- V</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_shutdown_card" style="border-left:6px solid #b77a4f">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <rect x="3" y="7" width="14" height="10" rx="2"></rect>
                </svg>
                Shutdown mode
              </div>
              <div class="feature-sub">Cut-off voltage</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="shutdown_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="shutdown" title="Edit shutdown">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="shutdown_set">-- V</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="shutdown_default_card">-- V</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="shutdown_minmax">-- / -- V</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_hiss_card" style="border-left:6px solid #2fd1a6">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M5 12c2-2 4-2 6 0s4 2 6 0"></path>
                </svg>
                Audible Hiss band
              </div>
              <div class="feature-sub">Play frequency</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="hiss_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="hiss" title="Edit hiss">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="hiss_set">-- %</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="hiss_default_card">-- %</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="hiss_minmax">-- / -- %</div>
            </div>
          </div>
        </div>

      </div>

      <div class="footer">
        <div style="display:flex;gap:12px;align-items:center">
          <div id="statusDot" style="width:12px;height:12px;border-radius:50%;background:#ff6b6b"></div>
          <div class="muted" id="bleText">Disconnected</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="copyParsed" class="btn-ghost">Copy LIVE</button>
          <button id="copyInit" class="btn-ghost">Copy INIT</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" id="featureModal">
      <span class="closeX" id="modalClose" style="position:absolute;right:12px;top:8px;cursor:pointer">✕</span>
      <h2 id="modalTitle">Feature</h2>

      <div class="toggle">
        <div class="muted">Disabled</div>
        <div class="switch" id="modalToggle"><div class="knob"></div></div>
        <div class="muted">Enabled</div>
      </div>

      <div style="height:1px;background:#dfe9f1;margin:8px 0"></div>

      <div style="text-align:center">
        <div class="muted" id="sliderLabel">Duration</div>
        <input type="range" id="modalSlider" min="0" max="100" step="1" style="width:100%;margin-top:12px" />
        <div id="modalSliderValue" style="font-weight:800;margin-top:10px">0</div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <div class="muted" id="sliderMinLabel">min</div>
          <div class="muted" id="sliderMaxLabel">max</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:14px">
        <button id="modalReset" class="btn-ghost">Reset</button>
        <div style="display:flex;gap:8px">
          <button id="modalSave" class="connectBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ==========================
   BLE + parsing + UI JS (unchanged behaviour)
   ========================== */

/* UUIDs & frames */
const serviceUuid = "0000fff0-0000-1000-8000-00805f9b34fb";
const notifyCharUuid = "0000fff1-0000-1000-8000-00805f9b34fb";
const writeCharUuid = "0000fff2-0000-1000-8000-00805f9b34fb";

const LIVE_CMD_HEX = "FD FC FB FA 04 00 4C 49 56 45 04 03 02 01";
const INIT_CMD_HEX = "FD FC FB FA 04 00 49 4E 49 54 04 03 02 01";

/* CMD bytes */
const CMD_BYTES = {
  beep: [0x42,0x45,0x45,0x50],
  standby: [0x53,0x54,0x41,0x4E],
  shutdown: [0x53,0x48,0x55,0x54],
  hiss: [0x48,0x49,0x53,0x53]
};

/* DOM refs */
const connectButton = document.getElementById("connectButton");
const disconnectButton = document.getElementById("disconnectButton");
const sendLiveBtn = document.getElementById("sendLiveBtn");
const sendInitBtn = document.getElementById("sendInitBtn");
const startAutoBtn = document.getElementById("startAutoBtn");
const stopAutoBtn = document.getElementById("stopAutoBtn");
const recvRaw = document.getElementById("recvRaw");
const clearRaw = document.getElementById("clearRaw");
const forceParse = document.getElementById("forceParse");
const deviceName = document.getElementById("deviceName");
const bleText = document.getElementById("bleText");
const statusDot = document.getElementById("statusDot");
const autoStatus = document.getElementById("autoStatus");

/* LIVE card elements */
const card_battery = document.getElementById("card_battery");
const card_current_val = document.getElementById("card_current_val");
const card_temp_value = document.getElementById("card_temp_value");
const card_minfreq = document.getElementById("card_minfreq");
const card_maxfreq = document.getElementById("card_maxfreq");
const card_waveval = document.getElementById("card_waveval");
const card_pattern_val = document.getElementById("card_pattern_val");
const card_days = document.getElementById("card_days");
const card_hhmmss = document.getElementById("card_hhmmss");

/* INIT feature elements */
const beep_enabled_card = document.getElementById("beep_enabled_card");
const beep_set = document.getElementById("beep_set");
const beep_default_card = document.getElementById("beep_default_card");
const beep_minmax = document.getElementById("beep_minmax");

const standby_enabled_card = document.getElementById("standby_enabled_card");
const standby_set = document.getElementById("standby_set");
const standby_default_card = document.getElementById("standby_default_card");
const standby_minmax = document.getElementById("standby_minmax");

const shutdown_enabled_card = document.getElementById("shutdown_enabled_card");
const shutdown_set = document.getElementById("shutdown_set");
const shutdown_default_card = document.getElementById("shutdown_default_card");
const shutdown_minmax = document.getElementById("shutdown_minmax");

const hiss_enabled_card = document.getElementById("hiss_enabled_card");
const hiss_set = document.getElementById("hiss_set");
const hiss_default_card = document.getElementById("hiss_default_card");
const hiss_minmax = document.getElementById("hiss_minmax");

/* modal refs */
const modalBackdrop = document.getElementById('modalBackdrop');
const modalToggle = document.getElementById('modalToggle');
const modalSlider = document.getElementById('modalSlider');
const modalSliderValue = document.getElementById('modalSliderValue');
const sliderLabel = document.getElementById('sliderLabel');
const sliderMinLabel = document.getElementById('sliderMinLabel');
const sliderMaxLabel = document.getElementById('sliderMaxLabel');
const modalReset = document.getElementById('modalReset');
const modalSave = document.getElementById('modalSave');
const modalClose = document.getElementById('modalClose');
const modalTitle = document.getElementById('modalTitle');

/* state */
let device, server, notifyChar, writeChar;
let lastPacket = null;
let currentInitData = null;
let autoIntervalId = null;
let writeInProgress = false;
let editingFeature = null;
let pendingSave = null;
let awaitingInitPromise = null;

/* helpers */
function hexToBytes(hexStr){
  const cleaned = hexStr.replace(/0x/g,"").replace(/[^A-Fa-f0-9]/g,"");
  const out = new Uint8Array(cleaned.length/2);
  for(let i=0;i<cleaned.length;i+=2) out[i/2] = parseInt(cleaned.substr(i,2),16);
  return out;
}
function bytesToHexUpper(bytes){
  return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0').toUpperCase()).join(' ');
}
function appendRaw(bytes, label=''){
  const t = new Date().toLocaleTimeString();
  lastPacket = bytes;
  const tag = label ? ` [${label}]` : '';
  recvRaw.innerHTML += `[${t}]${tag} ${bytesToHexUpper(bytes)}<br>`;
  recvRaw.scrollTop = recvRaw.scrollHeight;
  console.log(`RX${tag}: ${bytesToHexUpper(bytes)}`);
}
function readU8(buf, idx){ return (idx < buf.length) ? buf[idx] : null; }
function readU16le(buf, lo, hi){ const l=readU8(buf,lo), h=readU8(buf,hi); if(l===null||h===null) return null; return (h<<8) | l; }
function isTagAt(buf, offset, tagStr){ if(!buf || buf.length < offset + tagStr.length) return false; for(let i=0;i<tagStr.length;i++) if(buf[offset+i] !== tagStr.charCodeAt(i)) return false; return true; }

/* LIVE parsing & display */
function parseLivePacket(bytes){
  const buf = Uint8Array.from(bytes);
  if(buf.length < 28) return { error:"LIVE too short" };
  return {
    battery_mV: readU16le(buf,10,11),
    current_mA: (() => {
      const raw = readU16le(buf,12,13);
      return (raw != null) ? (raw/1000) : null;
    })(),
    temp_raw: readU16le(buf,14,15),
    min_Hz: readU16le(buf,16,17),
    max_Hz: readU16le(buf,18,19),
    waveVal: readU16le(buf,20,21),
    pattern: readU8(buf,22),
    days: readU16le(buf,23,24),
    hh: readU8(buf,25), mm: readU8(buf,26), ss: readU8(buf,27),
    rawHex: bytesToHexUpper(buf)
  };
}
function showLive(obj){
  if(!obj || obj.error){
    card_battery.textContent="-- V";
    card_current_val.textContent="-- mA";
    return;
  }
  card_battery.textContent = (obj.battery_mV != null) ? (obj.battery_mV/1000).toFixed(3) + " V" : "-- V";
  card_current_val.textContent = (obj.current_mA != null) ? obj.current_mA.toFixed(3) + " mA" : "-- mA";
  card_temp_value.textContent = (obj.temp_raw != null) ? (obj.temp_raw/100).toFixed(2) + " °C" : "-- °C";
  card_minfreq.textContent = (obj.min_Hz != null) ? (obj.min_Hz/1000).toFixed(3) + " kHz" : "-- kHz";
  card_maxfreq.textContent = (obj.max_Hz != null) ? (obj.max_Hz/1000).toFixed(3) + " kHz" : "-- kHz";
  card_waveval.textContent = (obj.waveVal != null) ? obj.waveVal.toString() : "--";
  card_pattern_val.textContent = (obj.pattern != null) ? obj.pattern.toString() : "--";
  card_days.textContent = (obj.days != null) ? obj.days.toString() + " Days" : "-- Days";
  card_hhmmss.textContent = (obj.hh !== undefined) ? `${String(obj.hh).padStart(2,"0")}:${String(obj.mm||0).padStart(2,"0")}:${String(obj.ss||0).padStart(2,"0")}` : "--:--:--";

  // visualizer integration
  try{
    if(window.__spectrum && typeof window.__spectrum.setRangeAndPpm === 'function'){
      window.__spectrum.setRangeAndPpm(obj.min_Hz, obj.max_Hz, obj.waveVal);
    }
  }catch(e){ console.warn("spectrum integration error", e); }
}

/* INIT parsing & display (unchanged) */
function parseInitPacket(bytes){
  const buf = Uint8Array.from(bytes);
  if(buf.length < 51) return { error:"INIT too short" };

  const beep_en = readU8(buf,11);
  const beep_en_default = readU8(buf,12);
  const beep_val = readU16le(buf,13,14);
  const beep_min = readU16le(buf,15,16);
  const beep_max = readU16le(buf,17,18);
  const beep_def = readU16le(buf,19,20);

  const standby_en = readU8(buf,21);
  const standby_en_default = readU8(buf,22);
  const standby_val = readU16le(buf,23,24);
  const standby_minv = readU16le(buf,25,26);
  const standby_maxv = readU16le(buf,27,28);
  const standby_defv = readU16le(buf,29,30);

  const shutdown_en = readU8(buf,31);
  const shutdown_en_default = readU8(buf,32);
  const shutdown_val = readU16le(buf,33,34);
  const shutdown_minv = readU16le(buf,35,36);
  const shutdown_maxv = readU16le(buf,37,38);
  const shutdown_defv = readU16le(buf,39,40);

  const hiss_en = readU8(buf,41);
  const hiss_en_default = readU8(buf,42);
  const hiss_val = readU16le(buf,43,44);
  const hiss_minv = readU16le(buf,45,46);
  const hiss_maxv = readU16le(buf,47,48);
  const hiss_defv = readU16le(buf,49,50);

  return {
    beep:{enabled:beep_en===1,en_default:beep_en_default===1,value:beep_val,min:beep_min,max:beep_max,def:beep_def},
    standby:{enabled:standby_en===1,en_default:standby_en_default===1,value_mV:standby_val,min_mV:standby_minv,max_mV:standby_maxv,def_mV:standby_defv},
    shutdown:{enabled:shutdown_en===1,en_default:shutdown_en_default===1,value_mV:shutdown_val,min_mV:shutdown_minv,max_mV:shutdown_maxv,def_mV:shutdown_defv},
    hiss:{enabled:hiss_en===1,en_default:hiss_en_default===1,value_pct:hiss_val,min_pct:hiss_minv,max_pct:hiss_maxv,def_pct:hiss_defv},
    rawHex: bytesToHexUpper(buf), _rawBuf: buf
  };
}
function showInit(obj){
  if(!obj || obj.error){ currentInitData = null; return; }
  currentInitData = obj;

  beep_enabled_card.textContent = obj.beep.enabled ? "Enabled" : "Disabled";
  beep_set.textContent = (obj.beep.value!=null) ? `${obj.beep.value} s` : "-- s";
  beep_default_card.textContent = (obj.beep.def!=null) ? `${obj.beep.def} s` : "-- s";
  beep_minmax.textContent = `${obj.beep.min ?? "--"} / ${obj.beep.max ?? "--"} s`;

  standby_enabled_card.textContent = obj.standby.enabled ? "Enabled" : "Disabled";
  standby_set.textContent = (obj.standby.value_mV!=null) ? `${(obj.standby.value_mV/1000).toFixed(3)} V` : "-- V";
  standby_default_card.textContent = (obj.standby.def_mV!=null) ? `${(obj.standby.def_mV/1000).toFixed(3)} V` : "-- V";
  standby_minmax.textContent = `${(obj.standby.min_mV!=null ? (obj.standby.min_mV/1000).toFixed(3):"--")} / ${(obj.standby.max_mV!=null ? (obj.standby.max_mV/1000).toFixed(3):"--")} V`;

  shutdown_enabled_card.textContent = obj.shutdown.enabled ? "Enabled" : "Disabled";
  shutdown_set.textContent = (obj.shutdown.value_mV!=null) ? `${(obj.shutdown.value_mV/1000).toFixed(3)} V` : "-- V";
  shutdown_default_card.textContent = (obj.shutdown.def_mV!=null) ? `${(obj.shutdown.def_mV/1000).toFixed(3)} V` : "-- V";
  shutdown_minmax.textContent = `${(obj.shutdown.min_mV!=null ? (obj.shutdown.min_mV/1000).toFixed(3):"--")} / ${(obj.shutdown.max_mV!=null ? (obj.shutdown.max_mV/1000).toFixed(3):"--")} V`;

  hiss_enabled_card.textContent = obj.hiss.enabled ? "Enabled" : "Disabled";
  hiss_set.textContent = (obj.hiss.value_pct!=null) ? `${obj.hiss.value_pct} %` : "-- %";
  hiss_default_card.textContent = (obj.hiss.def_pct!=null) ? `${obj.hiss.def_pct} %` : "-- %";
  hiss_minmax.textContent = `${obj.hiss.min_pct ?? "--"} / ${obj.hiss.max_pct ?? "--"} %`;

  console.log("INIT parsed & UI updated");
}

/* write helper with logging */
async function writeFrame(bytes, label){
  if(!writeChar) throw new Error("Not connected");
  console.log("TX " + label + ": " + bytesToHexUpper(bytes));
  try { writeInProgress = true; await writeChar.writeValue(bytes); }
  catch(e){ console.error("Write error:", e); throw e; }
  finally{ writeInProgress = false; }
}
async function sendLiveCmd(){ if(writeInProgress) return console.warn("Write in progress"); const d = hexToBytes(LIVE_CMD_HEX); await writeFrame(d, "LIVE"); }
async function sendInitCmd(){ if(writeInProgress) return console.warn("Write in progress"); const d = hexToBytes(INIT_CMD_HEX); await writeFrame(d, "INIT"); }

/* connect/disconnect (stops spectrum on disconnect) */
async function connect() {
  console.log("Connect button clicked");
  if (!navigator.bluetooth) {
    alert("Web Bluetooth is not available in this browser. Use Chrome/Chromium with Web Bluetooth enabled.");
    console.error("navigator.bluetooth missing");
    return;
  }

  const requestOptions = {
    filters: [{ namePrefix: "CARCAT" }, { name: "CARCAT_5G" }],
    optionalServices: [serviceUuid],
  };
  console.log("Requesting device with options:", requestOptions);

  try {
    device = await navigator.bluetooth.requestDevice(requestOptions);
    if (!device) {
      console.warn("No device selected (user probably cancelled chooser).");
      return;
    }
    console.log("Device selected:", device.name || device.id);

    device.addEventListener("gattserverdisconnected", onDeviceDisconnected);

    console.log("Connecting to GATT server...");
    server = await device.gatt.connect();

    console.log("Getting primary service:", serviceUuid);
    const svc = await server.getPrimaryService(serviceUuid);

    console.log("Getting characteristics...");
    notifyChar = await svc.getCharacteristic(notifyCharUuid);
    writeChar = await svc.getCharacteristic(writeCharUuid);

    console.log("Starting notifications...");
    await notifyChar.startNotifications();
    notifyChar.addEventListener("characteristicvaluechanged", onNotify);

    deviceName.textContent = device.name || device.id;
    bleText.textContent = "Connected";
    statusDot.style.background = "#27b56b";

    connectButton.disabled = true;
    disconnectButton.disabled = false;
    sendLiveBtn.disabled = false;
    sendInitBtn.disabled = false;
    startAutoBtn.disabled = false;
    stopAutoBtn.disabled = true;

    console.log("Connected and notifications started.");
  } catch (err) {
    console.error("Connect failed:", err);
    if (err.name === "NotFoundError" || /User cancelled/i.test(err.message || "")) {
      console.warn("User cancelled the device chooser.");
    } else {
      alert("Connect failed: " + (err.message || err));
    }
    deviceName.textContent = "Not connected";
    bleText.textContent = "Disconnected";
    statusDot.style.background = "#ff6b6b";
    connectButton.disabled = false;
    disconnectButton.disabled = true;
    sendLiveBtn.disabled = true;
    sendInitBtn.disabled = true;
    startAutoBtn.disabled = true;
    stopAutoBtn.disabled = true;
  }
}

function onDeviceDisconnected(event) {
  const dev = event?.target;
  console.log("Device disconnected:", dev ? (dev.name || dev.id) : dev);
  deviceName.textContent = "Not connected";
  bleText.textContent = "Disconnected";
  statusDot.style.background = "#ff6b6b";

  connectButton.disabled = false;
  disconnectButton.disabled = true;
  sendLiveBtn.disabled = true;
  sendInitBtn.disabled = true;
  startAutoBtn.disabled = true;
  stopAutoBtn.disabled = true;

  // Stop visualizer when device disconnects
  try{ if(window.__spectrum && typeof window.__spectrum.stop === 'function') window.__spectrum.stop(); }catch(e){console.warn(e);}
}

async function disconnect() {
  try {
    if (device) {
      console.log("Disconnect requested for device:", device.name || device.id);
      if (device.gatt && device.gatt.connected) {
        device.gatt.disconnect();
        console.log("Device gatt.disconnect() called");
      } else {
        console.log("Device was already disconnected.");
      }
    }
  } catch (e) {
    console.error("Error during disconnect:", e);
  } finally {
    deviceName.textContent = "Not connected";
    bleText.textContent = "Disconnected";
    statusDot.style.background = "#ff6b6b";

    connectButton.disabled = false;
    disconnectButton.disabled = true;
    sendLiveBtn.disabled = true;
    sendInitBtn.disabled = true;
    startAutoBtn.disabled = true;
    stopAutoBtn.disabled = true;

    // Stop visualizer on user disconnect as well
    try{ if(window.__spectrum && typeof window.__spectrum.stop === 'function') window.__spectrum.stop(); }catch(e){console.warn(e);}
  }
}

/* Notify handler */
function onNotify(ev){
  const arr = new Uint8Array(ev.target.value.buffer);

  if (isTagAt(arr, 6, "LIVE") && arr.length >= 28) {
    appendRaw(arr, 'LIVE');
    const liveParsed = parseLivePacket(arr);
    if (!liveParsed.error) showLive(liveParsed);
    return;
  }

  if (isTagAt(arr, 6, "INIT") && arr.length >= 51) {
    appendRaw(arr, 'INIT');
    const initParsed = parseInitPacket(arr);
    if (!initParsed.error) {
      showInit(initParsed);

      // resolve any waiting gear -> INIT request
      try {
        if (awaitingInitPromise && typeof awaitingInitPromise._resolve === 'function') {
          awaitingInitPromise._resolve(initParsed);
          awaitingInitPromise = null;
        }
      } catch (e) { console.warn("Error resolving awaitingInitPromise", e); }

      // check pending save ack (byte index 10 == 1)
      try {
        const buf = initParsed._rawBuf;
        if (pendingSave && buf && buf.length > 10 && buf[10] === 1) {
          console.log("ACK INIT received (byte10==1) for pending save");
          pendingSave.resolve({ feature: pendingSave.feature, value: pendingSave.value, buf });
          pendingSave = null;
        }
      } catch (e) { console.warn("ack check error", e); }
    }
    return;
  }

  appendRaw(arr, '');
}

/* Auto LIVE */
function startAutoLive(){
  if(autoIntervalId) return;
  if(!writeChar){ alert("Not connected"); return; }
  autoStatus.textContent = "Auto ON";
  startAutoBtn.disabled = true;
  stopAutoBtn.disabled = false;
  autoIntervalId = setInterval(()=>{ if(!writeInProgress) sendLiveCmd(); },500);
}
function stopAutoLive(){
  if(autoIntervalId) clearInterval(autoIntervalId);
  autoIntervalId = null;
  autoStatus.textContent = "Idle";
  startAutoBtn.disabled = false;
  stopAutoBtn.disabled = true;
}

/* waitForNextInit & waitForInitAck & performSaveWrite (unchanged) */
function waitForNextInit(timeoutMs = 3000) {
  if (awaitingInitPromise) return awaitingInitPromise;
  let timer;
  awaitingInitPromise = new Promise((resolve, reject) => {
    timer = setTimeout(() => {
      awaitingInitPromise = null;
      reject(new Error("INIT timeout"));
    }, timeoutMs);
    awaitingInitPromise._resolve = (initParsed) => {
      clearTimeout(timer);
      awaitingInitPromise = null;
      resolve(initParsed);
    };
  });
  return awaitingInitPromise;
}
function waitForInitAck(feature, value, timeoutMs = 5000){
  if(pendingSave) throw new Error("pendingSave already exists");
  return new Promise((resolve, reject) => {
    const timer = setTimeout(() => {
      if (pendingSave) pendingSave = null;
      reject(new Error("timeout"));
    }, timeoutMs);

    pendingSave = {
      feature,
      value,
      resolve: (info) => { clearTimeout(timer); pendingSave = null; resolve(info); },
      reject: (err) => { clearTimeout(timer); pendingSave = null; reject(err); }
    };
  });
}
async function performSaveWrite(featureKey, enabledNow, sliderRaw){
  if(!writeChar) throw new Error("Not connected");
  if(writeInProgress) throw new Error("Write in progress");
  const cmd = CMD_BYTES[featureKey];
  if(!cmd) throw new Error("Unknown feature cmd");

  const frame = new Uint8Array(4 + 2 + 4 + 1 + 2 + 4);
  let p = 0;
  frame[p++] = 0xFD; frame[p++] = 0xFC; frame[p++] = 0xFB; frame[p++] = 0xFA;
  frame[p++] = 0x07; frame[p++] = 0x00;
  frame[p++] = cmd[0]; frame[p++] = cmd[1]; frame[p++] = cmd[2]; frame[p++] = cmd[3];
  frame[p++] = enabledNow & 0xFF;
  frame[p++] = sliderRaw & 0xFF;
  frame[p++] = (sliderRaw >> 8) & 0xFF;
  frame[p++] = 0x04; frame[p++] = 0x03; frame[p++] = 0x02; frame[p++] = 0x01;

  console.log(`TX SAVE [${featureKey}] (EN=${enabledNow}) : ${bytesToHexUpper(frame)}`);

  await writeFrame(frame, `SAVE-${featureKey}`);
  return waitForInitAck(featureKey, sliderRaw, 5000);
}

/* modal wiring (unchanged) */
function updateModalSliderValueDisplaySeconds(){ modalSliderValue.textContent = modalSlider.value + " s"; }
function updateModalSliderValueDisplayVolts(){ modalSliderValue.textContent = (modalSlider.value/1000).toFixed(3) + " V"; }
function updateModalSliderValueDisplayPercent(){ modalSliderValue.textContent = modalSlider.value + " %"; }

function openFeatureModal(featureKey){
  if(!currentInitData) return alert("No INIT data available yet. Send INIT to populate.");
  const data = currentInitData[featureKey];
  if(!data) return alert("Feature data missing");
  editingFeature = featureKey;
  modalTitle.textContent = ({beep:"Audible beep", standby:"Standby mode", shutdown:"Shutdown mode", hiss:"Audible Hiss band"})[featureKey] || "Edit Feature";
  if(data.enabled) modalToggle.classList.add('on'); else modalToggle.classList.remove('on');

  if(featureKey === 'beep'){
    modalSlider.min = data.min ?? 0; modalSlider.max = data.max ?? Math.max((data.min||0)+1, data.value||0);
    modalSlider.step = 1; modalSlider.value = data.value ?? data.def ?? modalSlider.min;
    sliderLabel.textContent = "Duration - (after every)";
    sliderMinLabel.textContent = modalSlider.min + " s"; sliderMaxLabel.textContent = modalSlider.max + " s";
    updateModalSliderValueDisplaySeconds();
  } else if(featureKey === 'standby' || featureKey === 'shutdown'){
    const rawMin = data.min_mV ?? 0; const rawMax = data.max_mV ?? Math.max(rawMin+1, data.value_mV||0);
    modalSlider.min = rawMin; modalSlider.max = rawMax; modalSlider.step = 1;
    modalSlider.value = data.value_mV ?? data.def_mV ?? modalSlider.min;
    sliderLabel.textContent = featureKey === 'standby' ? "Charging voltage threshold" : "Cut-off voltage";
    sliderMinLabel.textContent = (rawMin/1000).toFixed(3) + " V"; sliderMaxLabel.textContent = (rawMax/1000).toFixed(3) + " V";
    updateModalSliderValueDisplayVolts();
  } else if(featureKey === 'hiss'){
    modalSlider.min = data.min_pct ?? 0; modalSlider.max = data.max_pct ?? Math.max((data.min_pct||0)+1, data.value_pct||0);
    modalSlider.step = 1; modalSlider.value = data.value_pct ?? data.def_pct ?? modalSlider.min;
    sliderLabel.textContent = "Play frequency (band %)";
    sliderMinLabel.textContent = modalSlider.min + " %"; sliderMaxLabel.textContent = modalSlider.max + " %";
    updateModalSliderValueDisplayPercent();
  }
  modalBackdrop.style.display = 'flex';
}
modalToggle.addEventListener('click', ()=> modalToggle.classList.toggle('on'));
modalSlider.addEventListener('input', ()=>{ if(!editingFeature) return; if(editingFeature === 'beep') updateModalSliderValueDisplaySeconds(); else if(editingFeature === 'standby' || editingFeature === 'shutdown') updateModalSliderValueDisplayVolts(); else if(editingFeature === 'hiss') updateModalSliderValueDisplayPercent(); });
modalReset.addEventListener('click', ()=>{ if(!editingFeature || !currentInitData) return; const d = currentInitData[editingFeature]; if(!d) return; if(d.en_default) modalToggle.classList.add('on'); else modalToggle.classList.remove('on'); if(editingFeature === 'beep'){ modalSlider.value = (d.def!=null)?d.def:(d.value!=null?d.value:modalSlider.min); updateModalSliderValueDisplaySeconds(); } else if(editingFeature === 'standby' || editingFeature === 'shutdown'){ modalSlider.value = (d.def_mV!=null)?d.def_mV:(d.value_mV!=null?d.value_mV:modalSlider.min); updateModalSliderValueDisplayVolts(); } else if(editingFeature === 'hiss'){ modalSlider.value = (d.def_pct!=null)?d.def_pct:(d.value_pct!=null?d.value_pct:modalSlider.min); updateModalSliderValueDisplayPercent(); } });
modalClose.addEventListener('click', closeModal);
modalBackdrop.addEventListener('click', (ev)=>{ if(ev.target === modalBackdrop) closeModal(); });
function closeModal(){ modalBackdrop.style.display = 'none'; editingFeature = null; }

modalSave.addEventListener('click', async ()=>{
  if(!editingFeature || !currentInitData){ closeModal(); return; }
  if(!writeChar) { alert("Not connected — can't send save command"); return; }
  if(writeInProgress) { alert("Write in progress — try again"); return; }

  const enabledNow = modalToggle.classList.contains('on') ? 1 : 0;
  const sliderRaw = parseInt(modalSlider.value,10);
  modalSave.disabled = true; const prevText = modalSave.textContent; modalSave.textContent = "Saving...";
  try{
    await performSaveWrite(editingFeature, enabledNow, sliderRaw);
    if(editingFeature === 'beep'){ currentInitData.beep.enabled = enabledNow===1; currentInitData.beep.value = sliderRaw; }
    else if(editingFeature === 'standby'){ currentInitData.standby.enabled = enabledNow===1; currentInitData.standby.value_mV = sliderRaw; }
    else if(editingFeature === 'shutdown'){ currentInitData.shutdown.enabled = enabledNow===1; currentInitData.shutdown.value_mV = sliderRaw; }
    else if(editingFeature === 'hiss'){ currentInitData.hiss.enabled = enabledNow===1; currentInitData.hiss.value_pct = sliderRaw; }
    showInit(currentInitData);
    closeModal();
    alert("Save acknowledged (INIT byte10=1).");
  }catch(e){
    console.warn("Save ACK error:", e);
    alert("No response received (timeout). Save not acknowledged.");
  }finally{
    modalSave.disabled = false; modalSave.textContent = prevText; pendingSave = null;
  }
});

/* gear buttons */
document.querySelectorAll('.gear').forEach(g => {
  g.addEventListener('click', async () => {
    const feature = g.dataset.feature;
    if (currentInitData) { openFeatureModal(feature); return; }
    if (!writeChar) { alert("Not connected. Please connect before editing features."); return; }
    try {
      console.log("No INIT cached — sending INIT request before opening modal");
      await sendInitCmd();
      const initParsed = await waitForNextInit(3000); // 3s
      console.log("Received INIT after request:", initParsed);
      openFeatureModal(feature);
    } catch (err) {
      console.warn("Failed to get INIT before opening modal:", err);
      alert("Could not get INIT from device. Try sending INIT manually or try again.");
    }
  });
});

/* UI wiring for other controls */
connectButton.addEventListener('click', connect);
disconnectButton.addEventListener('click', disconnect);
sendLiveBtn.addEventListener('click', sendLiveCmd);
sendInitBtn.addEventListener('click', sendInitCmd);
startAutoBtn.addEventListener('click', startAutoLive);
stopAutoBtn.addEventListener('click', stopAutoLive);
clearRaw.addEventListener('click', ()=> recvRaw.innerHTML = '');
forceParse.addEventListener('click', ()=>{
  if(!lastPacket) return alert("No packet available");
  if(!isTagAt(lastPacket, 6, "LIVE")) return alert("Latest packet does not have 'LIVE' at bytes 6..9 — parsing skipped.");
  if(lastPacket.length < 28) return alert("LIVE packet too short (need ≥28 bytes).");
  const parsed = parseLivePacket(lastPacket);
  if(parsed.error) alert(parsed.error); else showLive(parsed);
});
document.getElementById('copyParsed').addEventListener('click', async ()=>{
  const lines = [
    `Battery (V): ${card_battery.textContent}`,
    `Current (mA): ${card_current_val.textContent}`,
    `Temp (°C): ${card_temp_value.textContent}`,
    `Min(kHz): ${card_minfreq.textContent}`,
    `Max(kHz): ${card_maxfreq.textContent}`
  ].join("\n");
  await navigator.clipboard.writeText(lines); alert("LIVE parsed copied");
});
document.getElementById('copyInit').addEventListener('click', async ()=>{ if(!currentInitData) return alert("No INIT"); await navigator.clipboard.writeText(JSON.stringify(currentInitData,null,2)); alert("INIT copied"); });

/* initial checks */
if(!navigator.bluetooth){
  alert("Web Bluetooth not available in this browser.");
  connectButton.disabled = true;
  startAutoBtn.disabled = true;
  sendInitBtn.disabled = true;
  stopAutoBtn.disabled = true;
}
</script>

<!-- ===== Spectrum visualizer (exponential drop + axis labels + edge clipping) ===== -->
<script>
(function(){
  // ---------- constants / defaults ----------
  const DISPLAY_MIN_HZ = 15000;  // display axis start (fixed)
  const DISPLAY_MAX_HZ = 70000;  // display axis end (fixed)
  const DB_AXIS_MAX = 100;       // axis 0..100 dB shown
  const DB_DISPLAY_CAP = 100;    // normalization cap

  // ---------- state ----------
  let bins = 50;
  let sigma = 5.5;      // user control maps to falloff strength
  let minHz = 15000;
  let maxHz = 70000;
  let ppm = 1.0;
  let firstLive = false;
  let stopped = false;
  let startTime = performance.now();

  // ---------- DOM ----------
  const canvas = document.getElementById('spectrumCanvas');
  const stepsSlider = document.getElementById('spectrumSteps');
  const stepsLabel = document.getElementById('spectrumStepsLabel');
  const sigmaSlider = document.getElementById('spectrumSigma');
  const sigmaLabel = document.getElementById('spectrumSigmaLabel');
  const toggleBtn = document.getElementById('spectrumToggle');
  const infoBar = document.getElementById('spectrumInfo');
  const ctx = canvas.getContext('2d');

  // ---------- sizing ----------
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const cw = canvas.clientWidth || canvas.width;
    const ch = canvas.clientHeight || canvas.height;
    canvas.width = Math.max(400, Math.floor(cw * dpr));
    canvas.height = Math.max(180, Math.floor(ch * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resize);
  resize();

  // ---------- helpers ----------
  function expDrop(dist, falloff){
    // exponential drop: e^(-falloff * dist)
    return Math.exp(-Math.max(0, falloff) * dist);
  }

  function ampsToDbArray(amps){
    const eps = 1e-6;
    const raw = new Float32Array(amps.length);
    let maxRaw = -Infinity, minRaw = Infinity;
    for(let i=0;i<amps.length;i++){
      const a = Math.max(eps, amps[i]);
      const db = 20 * Math.log10(a);
      raw[i] = db;
      if(db > maxRaw) maxRaw = db;
      if(db < minRaw) minRaw = db;
    }
    if(maxRaw === -Infinity){
      maxRaw = 0; minRaw = -60;
    }
    if(maxRaw === minRaw){
      minRaw = maxRaw - 60;
    }
    const out = new Float32Array(amps.length);
    for(let i=0;i<amps.length;i++){
      out[i] = (raw[i] - minRaw) / (maxRaw - minRaw) * DB_DISPLAY_CAP;
      if(out[i] < 0) out[i] = 0;
      if(out[i] > DB_DISPLAY_CAP) out[i] = DB_DISPLAY_CAP;
    }
    return out;
  }

  function freqToX(freq, left, width){
    const f = Math.max(DISPLAY_MIN_HZ, Math.min(DISPLAY_MAX_HZ, freq));
    const frac = (f - DISPLAY_MIN_HZ) / (DISPLAY_MAX_HZ - DISPLAY_MIN_HZ);
    return left + frac * width;
  }

  // ---------- draw loop ----------
  function draw(now){
    if(stopped){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.font = "13px Inter, Arial, sans-serif";
      ctx.textBaseline = "middle";
      ctx.fillText("Disconnected — spectrum stopped", 12, canvas.clientHeight/2);
      requestAnimationFrame(draw);
      return;
    }

    if(!firstLive){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(255,255,255,0.03)";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = "rgba(255,255,255,0.8)";
      ctx.font = "13px Inter, Arial, sans-serif";
      ctx.textBaseline = "middle";
      ctx.fillText("Waiting for LIVE min/max/ppm...", 12, canvas.clientHeight/2);
      requestAnimationFrame(draw);
      return;
    }

    const W = canvas.clientWidth;
    const H = canvas.clientHeight;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // layout margins
    const leftMargin = 56;
    const bottomMargin = 44;
    const topMargin = 12;
    const drawW = W - leftMargin - 12;
    const drawH = H - bottomMargin - topMargin;

    // subtle background panel
    ctx.fillStyle = "rgba(255,255,255,0.01)";
    ctx.fillRect(leftMargin, topMargin, drawW, drawH);

    // draw Y axis grid and numeric labels (0..100 every 20)
    ctx.strokeStyle = "rgba(255,255,255,0.04)";
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.font = "11px Inter, Arial, sans-serif";
    ctx.textBaseline = "middle";
    for(let d=0; d<=DB_AXIS_MAX; d+=20){
      const y = topMargin + drawH - (d / DB_AXIS_MAX) * drawH;
      ctx.beginPath();
      ctx.moveTo(leftMargin, y);
      ctx.lineTo(leftMargin + drawW, y);
      ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.textAlign = "left";
      ctx.fillText(String(d), 8, y);
    }

    // draw X numeric ticks (15..70 kHz)
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "11px Inter, Arial, sans-serif";
    ctx.textBaseline = "top";
    const tickHz = [15000,20000,25000,30000,35000,40000,45000,50000,55000,60000,65000,70000];
    for(const f of tickHz){
      const x = freqToX(f, leftMargin, drawW);
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.beginPath();
      ctx.moveTo(x, topMargin + drawH);
      ctx.lineTo(x, topMargin + drawH + 6);
      ctx.stroke();
      ctx.textAlign = "center";
      ctx.fillText((f/1000).toFixed(0) + " kHz", x, topMargin + drawH + 8);
    }

    // compute sweep position (triangle)
    const effPpm = Math.max(0.0001, ppm);
    const cycleMs = 60000 / effPpm;
    const elapsed = now - startTime;
    const progress = (elapsed % cycleMs) / cycleMs;
    const pos = (progress <= 0.5) ? (progress * 2 * (bins - 1)) : ((2 - progress * 2) * (bins - 1));

    // build exponential amplitudes across bins (centered at pos)
    const amps = new Float32Array(bins);
    let maxAmp = 0;

    // falloff factor derived from sigma slider (higher sigma -> slower falloff)
    // invert mapping so slider value larger -> narrower/steeper falloff
    const falloff = Math.max(0.2, 1.2 + (11 - sigma) * 0.45);

    for(let i=0;i<bins;i++){
      const dist = Math.abs(i - pos);
      // exponential drop (sharper than gaussian); raise to a power for extra steepness
      let a = expDrop(dist, falloff);
      a = Math.pow(a, 1.4); // sharpen
      // small center plateau
      if(dist < 0.6) a = Math.max(a, 0.96);
      // slight natural jitter over time to look lively
      a *= (0.88 + 0.24 * Math.abs(Math.sin((i*0.7 + now/350))));
      amps[i] = a;
      if(a > maxAmp) maxAmp = a;
    }
    if(maxAmp > 0){
      for(let i=0;i<bins;i++) amps[i] /= maxAmp;
    }

    // edge clipping: when center freq is at/near device min or max, truncate lobe on that side
    const centerFreq = minHz + (maxHz - minHz) * (pos / Math.max(1, bins - 1));
    const edgeTolHz = (maxHz - minHz) * 0.02; // 2% tolerance
    const leftCut = centerFreq <= (minHz + edgeTolHz);
    const rightCut = centerFreq >= (maxHz - edgeTolHz);

    // apply an envelope to zero-out the cut side smoothly (or hard cut if exactly at edge)
    for(let i=0;i<bins;i++){
      // compute freq of bin
      const freq = minHz + (maxHz - minHz) * (i / Math.max(1, bins - 1));
      if(leftCut && freq < centerFreq - 1){ amps[i] = 0; }      // fully cut left side
      if(rightCut && freq > centerFreq + 1){ amps[i] = 0; }     // fully cut right side
    }

    // convert amps to dB-normalized (0..DB_DISPLAY_CAP) and to pixels
    const ampsDb = ampsToDbArray(amps);
    const barPixels = new Float32Array(bins);
    for(let i=0;i<bins;i++){
      const dbVal = ampsDb[i];
      const h = (dbVal / DB_AXIS_MAX) * drawH;
      barPixels[i] = h;
    }

    // draw bars
    const gap = 2;
    const nominalBarW = Math.max(2, (drawW - (bins - 1) * gap) / bins);
    for(let i=0;i<bins;i++){
      const freq = minHz + (maxHz - minHz) * (i / Math.max(1, bins - 1));
      const x = freqToX(freq, leftMargin, drawW);
      const barW = nominalBarW;
      const barH = barPixels[i];
      const y = topMargin + drawH - barH;

      const amp = Math.max(0, Math.min(1, amps[i]));
      const distFromCenter = Math.abs(i - pos);

      // color ramp: green -> yellow -> orange -> red using hue mapping
      const hue = 120 - Math.floor(120 * amp); // 120(green) to 0(red)
      const light = 45 + Math.floor(30 * amp);
      const sat = 70 + Math.floor(20 * amp);
      const alpha = 0.55 + 0.35 * amp;

      // highlight center
      let fillColor;
      if(distFromCenter < 0.6 && amp > 0.2){
        fillColor = `rgba(255,215,120,${Math.min(1,0.6 + 0.6*amp)})`; // golden highlight
      } else {
        fillColor = `hsla(${hue}, ${sat}%, ${light}%, ${alpha})`;
      }

      // draw rounded-top bar
      const bx = x - barW/2;
      const br = Math.min(8, barW/2);
      ctx.beginPath();
      ctx.moveTo(bx + br, y);
      ctx.lineTo(bx + barW - br, y);
      ctx.quadraticCurveTo(bx + barW, y, bx + barW, y + br);
      ctx.lineTo(bx + barW, topMargin + drawH);
      ctx.lineTo(bx, topMargin + drawH);
      ctx.lineTo(bx, y + br);
      ctx.quadraticCurveTo(bx, y, bx + br, y);
      ctx.closePath();

      // gradient fill for depth
      const grad = ctx.createLinearGradient(0, y, 0, topMargin + drawH);
      grad.addColorStop(0, fillColor);
      grad.addColorStop(1, "rgba(0,0,0,0.08)");
      ctx.fillStyle = grad;
      ctx.fill();

      // small highlight stroke on top of tall bars
      if(barH > 6){
        ctx.strokeStyle = "rgba(255,255,255,0.06)";
        ctx.lineWidth = 0.8;
        ctx.beginPath();
        ctx.moveTo(bx + 1, y + 1);
        ctx.lineTo(bx + barW - 1, y + 1);
        ctx.stroke();
      }
    }

    // show left axis label "dB" and right small legend (no numeric duplication)
    ctx.fillStyle = "rgba(255,255,255,0.85)";
    ctx.font = "12px Inter, Arial, sans-serif";
    ctx.textAlign = "left";
    ctx.fillText("dB", 8, topMargin);

    // show small device range + speed + center info; center dB randomized 50..80 as requested
    const centerDb = (50 + Math.random() * 30).toFixed(1);
    infoBar.textContent = `Min: ${(minHz/1000).toFixed(3)} kHz · Max: ${(maxHz/1000).toFixed(3)} kHz · Speed: ${ppm.toFixed(2)} ppm · center ${(centerFreq/1000).toFixed(3)} kHz · ${centerDb} dB`;

    requestAnimationFrame(draw);
  }
  requestAnimationFrame(draw);

  // ---------- UI wiring ----------
  stepsSlider.addEventListener('input', ()=>{
    bins = Math.max(2, Number(stepsSlider.value) || 50);
    stepsLabel.textContent = String(bins);
    startTime = performance.now();
    resize();
  });
  sigmaSlider.addEventListener('input', ()=>{
    sigma = Math.max(0.5, Number(sigmaSlider.value) || 5.5);
    sigmaLabel.textContent = sigma.toFixed(2);
  });
  toggleBtn.addEventListener('click', ()=>{
    stopped = !stopped;
    toggleBtn.textContent = stopped ? 'Resume' : 'Pause';
    if(!stopped) startTime = performance.now();
  });

  // defaults + disabled until first live
  stepsLabel.textContent = String(bins);
  sigmaLabel.textContent = sigma.toFixed(2);
  stepsSlider.disabled = true;
  sigmaSlider.disabled = true;
  toggleBtn.disabled = true;

  // ---------- external API ----------
  window.__spectrum = {
    setRangeAndPpm: function(min_v, max_v, ppm_v){
      const mn = Number(min_v);
      const mx = Number(max_v);
      if(!isNaN(mn) && !isNaN(mx) && mn>0 && mx>0){
        minHz = (mn < 1000 && mx < 1000) ? mn*1000 : mn;
        maxHz = (mn < 1000 && mx < 1000) ? mx*1000 : mx;
      }
      if(ppm_v != null && !isNaN(Number(ppm_v))) ppm = Number(ppm_v);
      if(!firstLive){
        firstLive = true;
        stopped = false;
        stepsSlider.disabled = false;
        sigmaSlider.disabled = false;
        toggleBtn.disabled = false;
        stepsSlider.value = bins;
        sigmaSlider.value = sigma;
        stepsLabel.textContent = String(bins);
        sigmaLabel.textContent = sigma.toFixed(2);
        startTime = performance.now();
        setTimeout(resize,50);
      } else {
        startTime = performance.now();
      }
    },
    setSteps: function(s){ bins = Math.max(2, Number(s)||bins); stepsSlider.value = bins; stepsLabel.textContent = String(bins); },
    setSigma: function(s){ sigma = Math.max(0.5, Number(s)||sigma); sigmaSlider.value = sigma; sigmaLabel.textContent = sigma.toFixed(2); },
    stop: function(){ stopped = true; firstLive = false; stepsSlider.disabled = true; sigmaSlider.disabled = true; toggleBtn.disabled = true; infoBar.textContent = "Disconnected — visualizer stopped."; },
    resume: function(){ stopped = false; firstLive = true; stepsSlider.disabled = false; sigmaSlider.disabled = false; toggleBtn.disabled = false; startTime = performance.now(); },
  };

  // read global initial values if provided externally
  try{
    if(typeof window.min_Hz !== 'undefined' && typeof window.max_Hz !== 'undefined'){
      window.__spectrum.setRangeAndPpm(window.min_Hz, window.max_Hz, window.waveVal || 1.0);
    }
  }catch(e){ /* ignore */ }

  setTimeout(resize,120);
})();
</script>
<!-- ===== End Spectrum visualizer ===== -->

</body>
</html>
