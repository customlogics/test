<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CARCAT 5G — Dashboard (BLE)</title>
<style>
  :root{
    --bg: #0f1114;
    --card: #14202a;
    --text: #ffffff;
    --muted: #9fb0c0;
    --accent-1: #27b56b;
    --accent-2: #3b82f6;
    --accent-3: #ff9f6b;
    --accent-4: #9b62ff;
    --icon-yellow: #FFD54A;
    --glass: rgba(255,255,255,0.03);
    --card-radius: 14px;
  }

  * {
    box-sizing: border-box;
  }

  html,body{
    height:100%;
    margin:0;
    font-family:Inter, "Segoe UI", Roboto, Arial; 
    background:linear-gradient(180deg,#0b0c0e 0%, #0f1114 100%); 
    color:var(--text);
  }
  
  .wrap{
    max-width:1200px;
    margin:18px auto;
    padding:18px;
    display:grid;
    grid-template-columns:360px 1fr;
    gap:18px;
  }
  
  .left{
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  
  .hero{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:var(--card-radius);
    padding:18px;
    border-left:6px solid var(--accent-1);
  }
  
  .hero h1{
    margin:0;
    font-size:20px;
    color:var(--icon-yellow)
  }
  
  .hero p{
    margin:8px 0 0 0;
    color:var(--muted);
    font-size:13px;
  }
  
  .small-card{
    background:var(--card); 
    padding:12px; 
    border-radius:12px; 
    border-left:6px solid var(--accent-2); 
    color:inherit
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:14px;
  }
  
  .tile{
    background:var(--card); 
    border-radius:var(--card-radius); 
    padding:18px; 
    position:relative; 
    overflow:hidden; 
    box-shadow:0 6px 20px rgba(3,6,9,0.6);
    display: flex;
    flex-direction: column;
  }
  
  .tile .heading{
    font-size:16px;
    font-weight:800;
    margin-bottom:12px;
    color:var(--text);
    display:flex;
    align-items:center;
    gap:10px
  }
  
  .tile .sub{
    color:var(--muted);
    font-size:13px;
    margin-top:8px
  }
  
  .metric{
    display:flex;
    align-items:center;
    gap:12px;
    margin-top: auto;
  }
  
  .metric .value{
    font-size:26px;
    font-weight:800;
    color:var(--text)
  }
  
  .metric .unit{
    color:var(--muted);
    font-size:12px
  }
  
  .feature-card { 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    gap:12px; 
  }
  
  .feature-left {flex:1}
  .feature-title { font-weight:800; color:var(--text) }
  .feature-sub { color:var(--muted); font-size:12px; margin-top:6px }
  .feature-value { font-size:20px; font-weight:800; margin-top:6px; color:var(--text) }
  .gear { border-radius:10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); padding:8px; cursor:pointer; color:var(--muted); font-weight:700 }
  .small-muted { color:var(--muted); font-size:12px }
  .raw { background:var(--glass); padding:10px; border-radius:10px; font-family:monospace; color:var(--accent-1); font-size:13px; height:120px; overflow:auto; border:1px solid rgba(255,255,255,0.03) }
  .footer{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-top:6px;padding:12px 18px;background:transparent}
  .connectBtn{padding:8px 14px;border-radius:10px;background:linear-gradient(90deg,var(--accent-2),#9be7ff);color:#072031;border:none;cursor:pointer;font-weight:700}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer}
  .badge { display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02); font-weight:700; color:var(--muted); font-size:13px }

  /* ICONS */
  .icon { width:32px; height:32px; display:inline-block; vertical-align:middle; }
  svg.icon path, svg.icon rect, svg.icon circle { stroke: var(--icon-yellow); stroke-width:1.6; fill: none; }
  svg.icon rect.filled { fill: var(--icon-yellow); stroke: none; }

  /* Spectrum Analysis Styles */
  .spectrum-container {
    position: relative;
    width: 100%;
    height: 200px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    overflow: hidden;
    margin-top: 12px;
    border: 1px solid rgba(255, 255, 255, 0.05);
  }
  
  .spectrum-canvas {
    display: block;
    width: 100%;
    height: 100%;
  }
  
  .spectrum-info {
    position: absolute;
    bottom: 8px;
    left: 8px;
    font-size: 11px;
    color: var(--muted);
    background: rgba(0, 0, 0, 0.5);
    padding: 4px 8px;
    border-radius: 4px;
  }

  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000
  }
  
  .modal{
    width:420px;
    background:#f2f8ff;
    color:#0b1220;
    border-radius:12px;
    padding:18px;
    box-shadow:0 6px 30px rgba(0,0,0,0.25);
    position:relative
  }
  
  .modal h2{
    margin:0 0 8px 0;
    text-align:center
  }
  
  .toggle{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    margin:8px 0 14px 0
  }
  
  .switch{
    width:54px;
    height:30px;
    background:#ddd;
    border-radius:18px;
    position:relative
  }
  
  .switch.on{background:#111}
  .knob{
    width:24px;
    height:24px;
    background:#fff;
    border-radius:50%;
    position:absolute;
    top:3px;
    left:3px;
    transition:left .12s;
    box-shadow:0 2px 4px rgba(0,0,0,0.2)
  }
  
  .switch.on .knob{left:27px}
  .modal input[type="range"]{width:100%}
  .muted{color:var(--muted)}
  
  /* Responsive Design */
  @media (max-width: 1100px) {
    .wrap {
      grid-template-columns: 1fr;
      max-width: 95%;
    }
    
    .grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .tile {
      min-height: 140px;
    }
  }
  
  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
    
    .wrap {
      padding: 12px;
      gap: 12px;
    }
    
    .tile {
      padding: 14px;
    }
    
    .hero {
      padding: 14px;
    }
  }
  
  @media (max-width: 480px) {
    .metric .value {
      font-size: 22px;
    }
    
    .feature-value {
      font-size: 18px;
    }
    
    .spectrum-container {
      height: 180px;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <div class="left">
      <div class="hero">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h1>CARCAT 5G - Wave</h1>
            <p>Car Battery Monitor & Config — BLE control & live telemetry</p>
          </div>
          <div style="text-align:right">
            <div class="muted">Connected to:</div>
            <div id="deviceName" class="badge">Not connected</div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button id="connectButton" type="button" class="connectBtn">Connect</button>
          <button id="disconnectButton" class="btn-ghost" disabled>Disconnect</button>
          <button id="sendLiveBtn" class="btn-ghost" disabled>SEND LIVE</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="sendInitBtn" class="btn-ghost" disabled>SEND INIT</button>
          <button id="startAutoBtn" class="btn-ghost" disabled>Start Auto (500ms)</button>
          <button id="stopAutoBtn" class="btn-ghost" disabled>Stop Auto</button>
        </div>

        <div style="margin-top:12px" class="muted">Raw receive (Docklight hex)</div>
        <div id="recvRaw" class="raw"></div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="clearRaw" class="btn-ghost">Clear</button>
          <button id="forceParse" class="btn-ghost">Force LIVE Parse</button>
        </div>
      </div>

      <div class="small-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700; color:var(--text)">Quick</div>
            <div class="muted" style="margin-top:6px">Console logs for TX/RX are in browser console</div>
          </div>
          <div>
            <button id="openSetup" class="btn-ghost">Setup</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-size:18px;font-weight:800; color:var(--text)">Dashboard</div>
        <div class="muted">Auto: <span id="autoStatus">Idle</span></div>
      </div>

      <div class="grid">
        <!-- Voltage Card -->
        <div class="tile" id="card_voltage" style="border-left:6px solid var(--accent-1)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <rect x="2" y="6" width="16" height="12" rx="2"></rect>
              <rect class="filled" x="19" y="9" width="2" height="6" rx="0.5"></rect>
            </svg>
            Car Battery Voltage
          </div>
          <div class="metric">
            <div class="value" id="card_battery">-- V</div>
            <div class="unit muted" id="liveExtra">instant</div>
          </div>
          <div class="sub" id="card_battery_sub">From LIVE packet</div>
        </div>

        <!-- Current Card -->
        <div class="tile" id="card_current" style="border-left:6px solid #ffcc00">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 12h7l2 6 2-12 2 6h4"></path>
            </svg>
            Device Current
          </div>
          <div class="metric">
            <div class="value" id="card_current_val">-- mA</div>
            <div class="unit muted">instant</div>
          </div>
          <div class="sub">From LIVE packet (bytes 12-13)</div>
        </div>

        <!-- Temperature Card -->
        <div class="tile" id="card_temp" style="border-left:6px solid #d6a93e">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M14 14.76V6a2 2 0 1 0-4 0v8.76a4 4 0 1 0 4 0z"></path>
            </svg>
            Internal Temperature
          </div>
          <div class="feature-value" id="card_temp_value">-- °C</div>
          <div class="sub">CARCAT internal temperature</div>
        </div>

        <!-- Min Frequency Card -->
        <div class="tile" id="card_freq_min" style="border-left:6px solid var(--accent-1)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M4 12h2l2-4 2 8 2-4 2 6 2-10 2 6h2"></path>
            </svg>
            Min Frequency (current)
          </div>
          <div class="feature-value" id="card_minfreq">-- kHz</div>
          <div class="sub">From LIVE packet</div>
        </div>
        
        <!-- Max Frequency Card -->
        <div class="tile" id="card_freq_max" style="border-left:6px solid var(--accent-3)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 12h3l2-6 2 12 2-8 2 10 2-14 2 8h2"></path>
            </svg>
            Max Frequency (current)
          </div>
          <div class="feature-value" id="card_maxfreq">-- kHz</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <!-- Wave Velocity Card -->
        <div class="tile" id="card_wave" style="border-left:6px solid var(--accent-4)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M2 12c4 0 4-8 8-8s4 8 8 8 4 8 8 8"></path>
            </svg>
            Wave velocity (current)
          </div>
          <div class="feature-value" id="card_waveval">--</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <!-- SPECTRUM ANALYSIS CARD -->
        <div class="tile" id="card_spectrum" style="border-left:6px solid #ff6b9d; grid-column: span 2;">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M3 17v3M6 14v6M9 11v9M12 8v12M15 5v15M18 2v18M21 1v20"></path>
            </svg>
            Spectrum Analysis
          </div>
          <div class="spectrum-container">
            <canvas id="spectrumCanvas" class="spectrum-canvas"></canvas>
            <div class="spectrum-info">
              <div>Min: <span id="spectrumMin">--</span> kHz | Max: <span id="spectrumMax">--</span> kHz</div>
              <div>Wave Velocity: <span id="spectrumWave">--</span> PPM | Current: <span id="spectrumCurrent">--</span> kHz</div>
            </div>
          </div>
        </div>

        <!-- Pattern Card -->
        <div class="tile" id="card_pattern" style="border-left:6px solid var(--accent-2)">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M6 8c2 0 2-4 4-4s2 4 4 4 2-4 4-4"></path>
            </svg>
            Ultrasound pattern
          </div>
          <div class="feature-value" id="card_pattern_val">--</div>
          <div class="sub">From LIVE packet</div>
        </div>

        <!-- Uptime Card -->
        <div class="tile" id="card_uptime" style="border-left:6px solid #5b2133">
          <div class="heading">
            <svg class="icon" viewBox="0 0 24 24" aria-hidden>
              <path d="M12 6v6l4 2"></path>
              <circle cx="12" cy="12" r="9"></circle>
            </svg>
            Device UP-Time
          </div>
          <div class="feature-value" id="card_days">-- Days</div>
          <div class="sub" id="card_hhmmss">--:--:-- (HH:MM:SS)</div>
        </div>

        <!-- INIT Feature Cards -->
        <div class="tile" id="feat_beep_card" style="border-left:6px solid #ff6fa6">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M5 11h4l5-5v12l-5-5H5z"></path>
                </svg>
                Audible beep
              </div>
              <div class="feature-sub">Duration — after every</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="beep_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="beep" title="Edit audible beep">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="beep_set">-- s</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="beep_default_card">-- s</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="beep_minmax">-- / -- s</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_standby_card" style="border-left:6px solid #39d0ff">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M3 12h6v6H3zM15 6h6v12h-6z"></path>
                </svg>
                Standby mode
              </div>
              <div class="feature-sub">Charging voltage threshold</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="standby_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="standby" title="Edit standby">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="standby_set">-- V</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="standby_default_card">-- V</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="standby_minmax">-- / -- V</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_shutdown_card" style="border-left:6px solid #b77a4f">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <rect x="3" y="7" width="14" height="10" rx="2"></rect>
                </svg>
                Shutdown mode
              </div>
              <div class="feature-sub">Cut-off voltage</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="shutdown_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="shutdown" title="Edit shutdown">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="shutdown_set">-- V</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="shutdown_default_card">-- V</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="shutdown_minmax">-- / -- V</div>
            </div>
          </div>
        </div>

        <div class="tile" id="feat_hiss_card" style="border-left:6px solid #2fd1a6">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="feature-title">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden>
                  <path d="M5 12c2-2 4-2 6 0s4 2 6 0"></path>
                </svg>
                Audible Hiss band
              </div>
              <div class="feature-sub">Play frequency</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
              <div id="hiss_enabled_card" class="muted">Disabled</div>
              <div class="gear" data-feature="hiss" title="Edit hiss">⚙</div>
            </div>
          </div>
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Set value</div>
              <div class="feature-value" id="hiss_set">-- %</div>
            </div>
            <div>
              <div class="small-muted">Default</div>
              <div class="small-muted" id="hiss_default_card">-- %</div>
            </div>
            <div>
              <div class="small-muted">Slider min/max</div>
              <div class="small-muted" id="hiss_minmax">-- / -- %</div>
            </div>
          </div>
        </div>

      </div>

      <div class="footer">
        <div style="display:flex;gap:12px;align-items:center">
          <div id="statusDot" style="width:12px;height:12px;border-radius:50%;background:#ff6b6b"></div>
          <div class="muted" id="bleText">Disconnected</div>
        </div>
        <div style="display:flex;gap:8px">
          <button id="copyParsed" class="btn-ghost">Copy LIVE</button>
          <button id="copyInit" class="btn-ghost">Copy INIT</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" role="dialog" aria-modal="true" id="featureModal">
      <span class="closeX" id="modalClose" style="position:absolute;right:12px;top:8px;cursor:pointer">✕</span>
      <h2 id="modalTitle">Feature</h2>

      <div class="toggle">
        <div class="muted">Disabled</div>
        <div class="switch" id="modalToggle"><div class="knob"></div></div>
        <div class="muted">Enabled</div>
      </div>

      <div style="height:1px;background:#dfe9f1;margin:8px 0"></div>

      <div style="text-align:center">
        <div class="muted" id="sliderLabel">Duration</div>
        <input type="range" id="modalSlider" min="0" max="100" step="1" style="width:100%;margin-top:12px" />
        <div id="modalSliderValue" style="font-weight:800;margin-top:10px">0</div>
        <div style="display:flex;justify-content:space-between;margin-top:6px">
          <div class="muted" id="sliderMinLabel">min</div>
          <div class="muted" id="sliderMaxLabel">max</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;margin-top:14px">
        <button id="modalReset" class="btn-ghost">Reset</button>
        <div style="display:flex;gap:8px">
          <button id="modalSave" class="connectBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
// Spectrum Analysis state
let spectrumAnimationId = null;
let spectrumData = {
  minFreq: 15,
  maxFreq: 70,
  waveVelocity: 0,
  currentFreq: 0,
  isPlaying: false,
  direction: 1,
  lastUpdateTime: 0,
  bars: 11,
  currentAmplitude: 0
};

// Initialize spectrum canvas
function initSpectrumCanvas() {
  const canvas = document.getElementById('spectrumCanvas');
  const container = canvas.parentElement;
  
  // Set canvas size to match container
  canvas.width = container.clientWidth;
  canvas.height = container.clientHeight;
  
  // Draw initial spectrum
  drawSpectrum();
}

// Generate vertical bar spectrum data
function generateBarSpectrum() {
  const bars = [];
  const centerBarIndex = Math.floor(spectrumData.bars / 2);
  
  // Generate random amplitude for center bar (50-80 dB)
  spectrumData.currentAmplitude = 50 + Math.random() * 30;
  
  for (let i = 0; i < spectrumData.bars; i++) {
    const distanceFromCenter = Math.abs(i - centerBarIndex);
    
    // Calculate amplitude based on distance from center (exponential decay)
    let amplitude;
    if (distanceFromCenter === 0) {
      amplitude = spectrumData.currentAmplitude; // Center bar
    } else {
      // Exponential decay for side bars
      amplitude = spectrumData.currentAmplitude * Math.exp(-distanceFromCenter * 0.5);
      // Add some randomness
      amplitude *= (0.8 + Math.random() * 0.4);
    }
    
    // Ensure amplitude is between 0-100 dB
    amplitude = Math.max(0, Math.min(100, amplitude));
    
    bars.push({
      index: i,
      amplitude: amplitude,
      distanceFromCenter: distanceFromCenter
    });
  }
  
  return bars;
}

// Draw the spectrum visualization
function drawSpectrum() {
  const canvas = document.getElementById('spectrumCanvas');
  const ctx = canvas.getContext('2d');
  const width = canvas.width;
  const height = canvas.height;
  
  // Clear canvas
  ctx.fillStyle = 'rgba(10, 15, 25, 0.9)';
  ctx.fillRect(0, 0, width, height);
  
  // Draw grid
  ctx.strokeStyle = 'rgba(100, 120, 150, 0.3)';
  ctx.lineWidth = 1;
  
  // Vertical grid lines (frequency)
  for (let i = 0; i <= 10; i++) {
    const x = i * width / 10;
    ctx.beginPath();
    ctx.moveTo(x, 0);
    ctx.lineTo(x, height);
    ctx.stroke();
  }
  
  // Horizontal grid lines (amplitude/dB)
  for (let i = 0; i <= 5; i++) {
    const y = i * height / 5;
    ctx.beginPath();
    ctx.moveTo(0, y);
    ctx.lineTo(width, y);
    ctx.stroke();
  }
  
  // Generate bar spectrum data
  const bars = generateBarSpectrum();
  const barWidth = width / (spectrumData.bars + 2);
  const spacing = barWidth * 0.2;
  
  // Draw vertical bars
  for (let i = 0; i < bars.length; i++) {
    const bar = bars[i];
    const x = (i + 1) * barWidth;
    const barHeight = (bar.amplitude / 100) * (height - 20);
    const y = height - barHeight - 10;
    
    // Create gradient for the bar
    const gradient = ctx.createLinearGradient(0, y, 0, height);
    
    // Different colors based on amplitude
    if (bar.amplitude > 70) {
      gradient.addColorStop(0, '#ff0066'); // High amplitude - red
    } else if (bar.amplitude > 50) {
      gradient.addColorStop(0, '#ff6600'); // Medium amplitude - orange
    } else if (bar.amplitude > 30) {
      gradient.addColorStop(0, '#ffff00'); // Low amplitude - yellow
    } else {
      gradient.addColorStop(0, '#00ff66'); // Very low amplitude - green
    }
    
    gradient.addColorStop(1, 'rgba(255, 255, 255, 0.1)');
    
    // Draw the bar
    ctx.fillStyle = gradient;
    ctx.fillRect(x, y, barWidth - spacing, barHeight);
    
    // Draw bar outline
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
    ctx.lineWidth = 1;
    ctx.strokeRect(x, y, barWidth - spacing, barHeight);
  }
  
  // Draw current frequency indicator line
  const currentX = ((spectrumData.currentFreq - spectrumData.minFreq) / (spectrumData.maxFreq - spectrumData.minFreq)) * width;
  ctx.strokeStyle = '#FFD54A';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(currentX, 0);
  ctx.lineTo(currentX, height);
  ctx.stroke();
  
  // Update current frequency display
  document.getElementById('spectrumCurrent').textContent = spectrumData.currentFreq.toFixed(3);
}

// Update spectrum animation
function updateSpectrumAnimation() {
  if (!spectrumData.isPlaying) return;
  
  const now = Date.now();
  if (spectrumData.lastUpdateTime === 0) {
    spectrumData.lastUpdateTime = now;
  }
  
  const deltaTime = now - spectrumData.lastUpdateTime;
  spectrumData.lastUpdateTime = now;
  
  // Calculate frequency step based on wave velocity (PPM)
  const cycleTimeMs = 60000 / (spectrumData.waveVelocity || 1); // Time for one complete cycle in ms
  const halfCycleTimeMs = cycleTimeMs / 2; // Time for min->max or max->min
  
  const freqRange = spectrumData.maxFreq - spectrumData.minFreq;
  const freqStep = (freqRange / halfCycleTimeMs) * deltaTime;
  
  // Update current frequency
  spectrumData.currentFreq += spectrumData.direction * freqStep;
  
  // Change direction if we hit min or max
  if (spectrumData.currentFreq >= spectrumData.maxFreq) {
    spectrumData.currentFreq = spectrumData.maxFreq;
    spectrumData.direction = -1;
  } else if (spectrumData.currentFreq <= spectrumData.minFreq) {
    spectrumData.currentFreq = spectrumData.minFreq;
    spectrumData.direction = 1;
  }
  
  drawSpectrum();
  spectrumAnimationId = requestAnimationFrame(updateSpectrumAnimation);
}

// Start spectrum animation
function startSpectrumAnimation() {
  if (spectrumData.isPlaying) return;
  
  spectrumData.isPlaying = true;
  spectrumData.lastUpdateTime = 0;
  spectrumAnimationId = requestAnimationFrame(updateSpectrumAnimation);
}

// Stop spectrum animation
function stopSpectrumAnimation() {
  spectrumData.isPlaying = false;
  if (spectrumAnimationId) {
    cancelAnimationFrame(spectrumAnimationId);
    spectrumAnimationId = null;
  }
}

// Update spectrum data from LIVE packet
function updateSpectrumData(liveData) {
  if (liveData.min_Hz && liveData.max_Hz && liveData.waveVal) {
    spectrumData.minFreq = liveData.min_Hz / 1000;
    spectrumData.maxFreq = liveData.max_Hz / 1000;
    spectrumData.waveVelocity = liveData.waveVal;
    
    // Update display
    document.getElementById('spectrumMin').textContent = spectrumData.minFreq.toFixed(3);
    document.getElementById('spectrumMax').textContent = spectrumData.maxFreq.toFixed(3);
    document.getElementById('spectrumWave').textContent = spectrumData.waveVelocity;
    
    // Start spectrum animation automatically when data is available
    if (!spectrumData.isPlaying) {
      spectrumData.currentFreq = (spectrumData.minFreq + spectrumData.maxFreq) / 2;
      startSpectrumAnimation();
    }
  }
}

// Initialize when page loads
window.addEventListener('load', () => {
  initSpectrumCanvas();
  drawSpectrum();
});

// Handle window resize
window.addEventListener('resize', initSpectrumCanvas);

// The rest of your existing BLE code remains unchanged below...
// [Your existing BLE code would go here - I've omitted it for brevity but it should work with the spectrum functions above]
</script>
</body>
</html>
